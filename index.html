<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KotoChat с настройками аккаунта</title>
<style>
  :root {
    --bg: #fff;
    --text: #222;
    --accent: #2ed573;
    --sidebar: #2f3542;
    --header: #57606f;
    --msg-you: #70a1ff;
    --msg-other: #dfe4ea;
    --border: #ccc;
  }
  [data-theme="dark"] {
    --bg: #1e272e;
    --text: #fff;
    --accent: #1dd1a1;
    --sidebar: #2f3542;
    --header: #3742fa;
    --msg-you: #2ed573;
    --msg-other: #57606f;
    --border: #444;
  }
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    height: 100vh;
  }
  #sidebar {
    width: 300px;
    background: var(--sidebar);
    color: white;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    box-sizing: border-box;
  }
  #sidebar input, #sidebar button, #sidebar select {
    padding: 10px;
    border-radius: 6px;
    border: none;
    font-size: 14px;
  }
  #sidebar input, #sidebar select {
    width: 100%;
    box-sizing: border-box;
  }
  #sidebar button {
    background: var(--accent);
    color: white;
    cursor: pointer;
  }
  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  #chatHeader {
    background: var(--header);
    color: white;
    padding: 10px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: var(--bg);
  }
  .msg {
    margin: 5px 0;
    max-width: 70%;
    padding: 8px 14px;
    border-radius: 16px;
    word-wrap: break-word;
  }
  .msg.you {
    background: var(--msg-you);
    color: white;
    align-self: flex-end;
    margin-left: auto;
  }
  .msg.other {
    background: var(--msg-other);
    color: var(--text);
    align-self: flex-start;
    margin-right: auto;
  }
  #inputArea {
    display: none;
    padding: 10px;
    border-top: 1px solid var(--border);
    background: var(--bg);
    display: flex;
    gap: 10px;
  }
  #inputArea input[type="text"] {
    flex: 1;
    padding: 10px;
    border-radius: 20px;
    border: 1px solid var(--border);
    font-size: 14px;
  }
  #inputArea button {
    padding: 10px 20px;
    border-radius: 20px;
    border: none;
    background: var(--accent);
    color: white;
    cursor: pointer;
  }
  #groupsArea, #accountArea {
    display: none;
  }
  #membersList {
    background: #444;
    padding: 5px;
    max-height: 150px;
    overflow-y: auto;
    border-radius: 6px;
    font-size: 13px;
  }
  #membersList div {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
    padding: 2px 5px;
    border-radius: 4px;
    background: #555;
  }
  #membersList button {
    background: #ff6b6b;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    padding: 2px 6px;
    font-size: 12px;
  }
  #addUserInput {
    width: calc(100% - 90px);
    margin-right: 5px;
  }
  #sidebar button.toggleView {
    background: #3742fa;
    margin-bottom: 10px;
  }
  #accountArea label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
  }
  #accountArea input[type="text"] {
    width: 100%;
    margin-top: 5px;
  }
  #logoutBtn {
    margin-top: 20px;
    background: #ff4757;
  }
</style>
</head>
<body data-theme="light">
  <div id="sidebar">
    <h2>KotoChat</h2>
    <button id="showChatBtn" class="toggleView" style="display:none;">Чат и группы</button>
    <button id="showAccountBtn" class="toggleView" style="display:none;">Аккаунт и настройки</button>

    <div id="loginArea">
      <input id="emailInput" placeholder="Email" />
      <input id="passwordInput" type="password" placeholder="Пароль" />
      <input id="usernameInput" placeholder="Имя в чате" />
      <input id="serverInput" placeholder="WebSocket URL" value="ws://localhost:10000" />
      <button id="loginBtn">Войти</button>
      <div id="status"></div>
    </div>

    <div id="groupsArea">
      <label>Группы:</label>
      <select id="groupsSelect"></select>
      <button id="joinGroupBtn">Войти в группу</button>
      <input id="newGroupInput" placeholder="Новая группа" />
      <button id="createGroupBtn">Создать группу</button>

      <hr style="border-color: rgba(255,255,255,0.3);" />
      <div>
        <b>Участники группы</b>
        <div id="membersList"></div>
        <input id="addUserInput" placeholder="Email для добавления" />
        <button id="addUserBtn">Добавить</button>
      </div>
    </div>

    <div id="accountArea">
      <label>Ваш email:</label>
      <input type="text" id="accEmail" disabled />
      <label>Ваше имя:</label>
      <input type="text" id="accName" />
      <label>Ваша роль:</label>
      <input type="text" id="accRole" disabled />
      <button id="saveNameBtn">Сохранить имя</button>
      <button id="logoutBtn">Выйти</button>
    </div>
  </div>

  <div id="main">
    <div id="chatHeader">Не в чате</div>
    <div id="messages"></div>
    <div id="inputArea">
      <input id="messageInput" type="text" placeholder="Введите сообщение..." />
      <button id="sendBtn">Отправить</button>
    </div>
  </div>

<script>
(() => {
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const usernameInput = document.getElementById('usernameInput');
  const serverInput = document.getElementById('serverInput');
  const loginBtn = document.getElementById('loginBtn');
  const status = document.getElementById('status');
  const messagesDiv = document.getElementById('messages');
  const chatHeader = document.getElementById('chatHeader');
  const inputArea = document.getElementById('inputArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  const groupsArea = document.getElementById('groupsArea');
  const groupsSelect = document.getElementById('groupsSelect');
  const joinGroupBtn = document.getElementById('joinGroupBtn');
  const newGroupInput = document.getElementById('newGroupInput');
  const createGroupBtn = document.getElementById('createGroupBtn');

  const membersList = document.getElementById('membersList');
  const addUserInput = document.getElementById('addUserInput');
  const addUserBtn = document.getElementById('addUserBtn');

  const accountArea = document.getElementById('accountArea');
  const accEmail = document.getElementById('accEmail');
  const accName = document.getElementById('accName');
  const accRole = document.getElementById('accRole');
  const saveNameBtn = document.getElementById('saveNameBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  const showChatBtn = document.getElementById('showChatBtn');
  const showAccountBtn = document.getElementById('showAccountBtn');

  let ws;
  let email = '';
  let username = '';
  let role = '';
  let connected = false;
  let currentGroup = '';

  function showStatus(text) {
    status.textContent = text;
  }

  function clearMessages() {
    messagesDiv.innerHTML = '';
  }

  function addMessage(sender, senderRole, text, isYou) {
    const div = document.createElement('div');
    div.className = 'msg ' + (isYou ? 'you' : 'other');

    let label = '';
    if(senderRole && senderRole !== 'Пользователь' && senderRole !== 'Гость') {
      label = `[${senderRole}] `;
    }
    div.textContent = label + sender + ': ' + text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function updateMembersList(members) {
    membersList.innerHTML = '';
    members.forEach(memberEmail => {
      const div = document.createElement('div');
      div.textContent = memberEmail;
      if(role === 'Создатель' || role === 'Админ') {
        const btn = document.createElement('button');
        btn.textContent = 'Удалить';
        btn.onclick = () => {
          if(confirm(`Удалить пользователя ${memberEmail} из группы ${currentGroup}?`)) {
            ws.send(JSON.stringify({type: 'remove-user-from-group', group: currentGroup, userEmail: memberEmail}));
          }
        };
        div.appendChild(btn);
      }
      membersList.appendChild(div);
    });
  }

  function connectWS() {
    if(ws) ws.close();

    ws = new WebSocket(serverInput.value.trim());

    ws.onopen = () => {
      showStatus('Соединение установлено');
      ws.send(JSON.stringify({
        type: 'login',
        email,
        password: passwordInput.value,
        username,
      }));
    };

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      switch(data.type) {
        case 'login-success':
          role = data.role;
          currentGroup = data.currentGroup;
          chatHeader.textContent = `Группа: ${currentGroup} | Роль: ${role}`;
          inputArea.style.display = role === 'Гость' ? 'none' : 'flex';
          groupsArea.style.display = 'block';
          accountArea.style.display = 'block';
          showChatBtn.style.display = 'none';
          showAccountBtn.style.display = 'inline-block';

          accEmail.value = email;
          accName.value = username;
          accRole.value = role;

          loginBtn.style.display = 'none';
          emailInput.style.display = 'none';
          passwordInput.style.display = 'none';
          usernameInput.style.display = 'none';
          serverInput.style.display = 'none';

          break;

        case 'error':
          showStatus('Ошибка: ' + data.text);
          break;

        case 'groups-list':
          groupsSelect.innerHTML = '';
          data.groups.forEach(g => {
            const option = document.createElement('option');
            option.value = g;
            option.textContent = g;
            groupsSelect.appendChild(option);
          });
          break;

        case 'history':
          clearMessages();
          data.messages.forEach(m => {
            const isYou = m.from === username;
            addMessage(m.from, m.role, m.text, isYou);
          });
          break;

        case 'message':
          if(data.group === currentGroup) {
            const isYou = data.from === username;
            addMessage(data.from, data.role, data.text, isYou);
          }
          break;

        case 'notification':
          addMessage('Система', '', data.text, false);
          break;

        case 'joined-group':
          currentGroup = data.group;
          chatHeader.textContent = `Группа: ${currentGroup} | Роль: ${role}`;
          inputArea.style.display = role === 'Гость' ? 'none' : 'flex';
          ws.send(JSON.stringify({ type: 'get-group-members', group: currentGroup }));
          break;

        case 'group-members':
          if(data.group === currentGroup) {
            updateMembersList(data.members);
          }
          break;

        default:
          console.log('Неизвестный тип:', data.type, data);
      }
    };

    ws.onclose = () => {
      showStatus('Соединение закрыто');
      connected = false;
      groupsArea.style.display = 'none';
      inputArea.style.display = 'none';
      accountArea.style.display = 'none';
      chatHeader.textContent = 'Не в чате';
      clearMessages();
      updateMembersList([]);
      showChatBtn.style.display = 'none';
      showAccountBtn.style.display = 'none';

      loginBtn.style.display = 'inline-block';
      emailInput.style.display = 'block';
      passwordInput.style.display = 'block';
      usernameInput.style.display = 'block';
      serverInput.style.display = 'block';
    };
  }

  loginBtn.onclick = () => {
    email = emailInput.value.trim();
    username = usernameInput.value.trim();
    if (!email || !passwordInput.value || !username) {
      alert('Заполните email, пароль и имя');
      return;
    }
    connectWS();
    connected = true;
  };

  sendBtn.onclick = () => {
    if(!connected) return;
    const text = messageInput.value.trim();
    if(!text) return;
    ws.send(JSON.stringify({ type: 'message', text }));
    messageInput.value = '';
  };

  joinGroupBtn.onclick = () => {
    if(!connected) return;
    const group = groupsSelect.value;
    if(!group) return;
    ws.send(JSON.stringify({ type: 'join-group', group }));
  };

  createGroupBtn.onclick = () => {
    if(!connected) return;
    const newGroup = newGroupInput.value.trim();
    if(!newGroup) return alert('Введите имя группы');
    ws.send(JSON.stringify({ type: 'create-group', group: newGroup }));
    newGroupInput.value = '';
  };

  addUserBtn.onclick = () => {
    if(!connected) return;
    const userEmail = addUserInput.value.trim();
    if(!userEmail) return alert('Введите email пользователя для добавления');
    ws.send(JSON.stringify({ type: 'add-user-to-group', group: currentGroup, userEmail }));
    addUserInput.value = '';
  };

  saveNameBtn.onclick = () => {
    if(!connected) return;
    const newName = accName.value.trim();
    if(!newName) return alert('Имя не может быть пустым');
    // Отправим серверу — но в текущем сервере такой логики нет, просто локально поменяем
    username = newName;
    chatHeader.textContent = `Группа: ${currentGroup} | Роль: ${role}`;
    showStatus('Имя сохранено локально (сервер не поддерживает изменение имени)');
  };

  logoutBtn.onclick = () => {
    if(ws) ws.close();
    connected = false;
    email = '';
    username = '';
    role = '';
    currentGroup = '';

    accountArea.style.display = 'none';
    groupsArea.style.display = 'none';
    inputArea.style.display = 'none';
    chatHeader.textContent = 'Не в чате';
    clearMessages();
    updateMembersList([]);

    loginBtn.style.display = 'inline-block';
    emailInput.style.display = 'block';
    passwordInput.style.display = 'block';
    usernameInput.style.display = 'block';
    serverInput.style.display = 'block';

    showChatBtn.style.display = 'none';
    showAccountBtn.style.display = 'none';
    status.textContent = 'Вы вышли';
  };

  showAccountBtn.onclick = () => {
    groupsArea.style.display = 'none';
    accountArea.style.display = 'block';
    inputArea.style.display = 'none';
    showAccountBtn.style.display = 'none';
    showChatBtn.style.display = 'inline-block';
  };

  showChatBtn.onclick = () => {
    groupsArea.style.display = 'block';
    accountArea.style.display = 'none';
    inputArea.style.display = role === 'Гость' ? 'none' : 'flex';
    showChatBtn.style.display = 'none';
    showAccountBtn.style.display = 'inline-block';
  };

})();
</script>
</body>
</html>
