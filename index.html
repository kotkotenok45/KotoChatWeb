<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>KotoChat</title>
  <style>
    body { font-family: sans-serif; background: #222; color: white; }
    .hidden { display: none; }
    .light { background: white; color: black; }
  </style>
</head>
<body>
  <h2>KotoChat</h2>
  <div id="auth">
    <input id="email" placeholder="–í–≤–µ–¥–∏—Ç–µ email"><br>
    <button onclick="sendCode()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button><br><br>
    <input id="code" placeholder="–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"><br>
    <button onclick="verifyCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
  </div>

  <div id="chat" class="hidden">
    <input id="username" placeholder="–ò–º—è">
    <input id="group" placeholder="–ì—Ä—É–ø–ø–∞">
    <button onclick="join()">–í–æ–π—Ç–∏</button><br><br>
    <div id="messages"></div>
    <input id="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button onclick="toggleTheme()">üåó</button>
  </div>

  <script>
    const ws = new WebSocket(location.origin.replace(/^http/, 'ws'));
    let emailVerified = false;

    function sendCode() {
      fetch('/send-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: document.getElementById('email').value })
      }).then(() => alert("–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!"));
    }

    function verifyCode() {
      fetch('/verify-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: document.getElementById('email').value, code: document.getElementById('code').value })
      }).then(res => {
        if (res.ok) {
          document.getElementById('auth').classList.add('hidden');
          document.getElementById('chat').classList.remove('hidden');
        } else {
          alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥");
        }
      });
    }

    function join() {
      const username = document.getElementById('username').value;
      const group = document.getElementById('group').value;
      ws.send(JSON.stringify({ type: 'join', username, group }));
    }

    function sendMessage() {
      const text = document.getElementById('input').value;
      ws.send(JSON.stringify({ type: 'message', text }));
      document.getElementById('input').value = '';
    }

    function toggleTheme() {
      document.body.classList.toggle('light');
    }

    ws.onmessage = (e) => {
      const data = JSON.parse(e.data);
      const box = document.getElementById('messages');
      if (data.type === 'message') {
        box.innerHTML += `<div><b>${data.username}</b> (${data.role}): ${data.text}</div>`;
      } else if (data.type === 'notification') {
        box.innerHTML += `<div><i>${data.text}</i></div>`;
      } else if (data.type === 'history') {
        for (const msg of data.messages) {
          box.innerHTML += `<div><b>${msg.username}</b> (${msg.role || '–ì–æ—Å—Ç—å'}): ${msg.text}</div>`;
        }
      }
    };
  </script>
</body>
</html>
