<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>KotoChat Web</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 600px;
        margin: auto;
        padding: 20px;
      }
      #chat {
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: auto;
        padding: 10px;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <h1>KotoChat Web</h1>
    <input id="username" placeholder="username" />
    <input id="password" type="password" placeholder="password" />
    <button id="login">Login</button>
    <div id="chat"></div>
    <input id="to" placeholder="send to" />
    <input id="text" placeholder="message" />
    <button id="send">Send</button>

    <script>
      let token, ws;

      document.getElementById("login").onclick = async () => {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });
        const data = await res.json();
        if (data.token) {
          token = data.token;
          ws = new WebSocket(
            `wss://kotochat-e22r.onrender.com?token=${encodeURIComponent(
              token
            )}`
          );
          ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            const chat = document.getElementById("chat");
            chat.innerHTML += `<div>${JSON.stringify(msg)}</div>`;
          };
        }
      };

      document.getElementById("send").onclick = () => {
        const to = document.getElementById("to").value;
        const text = document.getElementById("text").value;
        ws.send(JSON.stringify({ type: "send", to, text }));
      };
    </script>
  </body>
</html>
