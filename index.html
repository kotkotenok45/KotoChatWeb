<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KotoChat</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #2f3542;
      --accent: #2ed573;
      --sidebar: #2f3542;
      --header: #57606f;
      --msg-you: #70a1ff;
      --msg-other: #dfe4ea;
      --border: #ccc;
    }

    [data-theme="dark"] {
      --bg: #1e272e;
      --text: #ffffff;
      --accent: #1dd1a1;
      --sidebar: #2f3542;
      --header: #3742fa;
      --msg-you: #2ed573;
      --msg-other: #57606f;
      --border: #444;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
    }

    #sidebar {
      width: 260px;
      background: var(--sidebar);
      color: white;
      display: flex;
      flex-direction: column;
      padding: 15px;
      gap: 10px;
    }

    #sidebar input, #sidebar button {
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
    }

    #sidebar input {
      width: 100%;
      box-sizing: border-box;
    }

    #sidebar button {
      background: var(--accent);
      color: white;
      cursor: pointer;
    }

    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #chatHeader {
      background: var(--header);
      color: white;
      padding: 10px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: var(--bg);
    }

    .msg {
      margin: 5px 0;
      max-width: 70%;
      padding: 8px 14px;
      border-radius: 16px;
      word-wrap: break-word;
    }

    .msg.you {
      background: var(--msg-you);
      color: white;
      align-self: flex-end;
      margin-left: auto;
    }

    .msg.other {
      background: var(--msg-other);
      color: var(--text);
      align-self: flex-start;
      margin-right: auto;
    }

    #inputArea {
      display: flex;
      padding: 10px;
      border-top: 1px solid var(--border);
      background: var(--bg);
    }

    #inputArea input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid var(--border);
      font-size: 14px;
    }

    #inputArea button {
      margin-left: 10px;
      padding: 10px 20px;
      border-radius: 20px;
      border: none;
      background: var(--accent);
      color: white;
      cursor: pointer;
    }

    #callArea {
      display: flex;
      gap: 10px;
      padding: 10px;
      border-top: 1px solid var(--border);
      background: var(--bg);
    }

    #themeToggle {
      font-size: 13px;
      background: transparent;
      border: 1px solid white;
      color: white;
      padding: 4px 8px;
      border-radius: 8px;
      cursor: pointer;
    }

    #status {
      font-size: 12px;
      color: #aaa;
    }

    #authArea {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    audio {
      display: none;
    }
  </style>
</head>
<body data-theme="light">
  <div id="sidebar">
    <h2>KotoChat</h2>
    <button id="themeToggle">üåó –¢–µ–º–∞</button>
    <div id="authArea">
      <input id="userInput" placeholder="Email –∏–ª–∏ –Ω–æ–º–µ—Ä" />
      <input id="usernameInput" placeholder="–ò–º—è –≤ —á–∞—Ç–µ" />
      <input id="serverInput" placeholder="WebSocket URL" />
      <button id="loginBtn">–í–æ–π—Ç–∏</button>
    </div>
    <div id="status"></div>
  </div>
  <div id="main">
    <div id="chatHeader">
      <span id="groupTitle">–ù–µ –≤ —á–∞—Ç–µ</span>
      <button id="callBtn">üìû</button>
    </div>
    <div id="messages"></div>
    <div id="inputArea" style="display:none;">
      <input id="messageInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <div id="callArea" style="display:none;">
      <button id="hangupBtn">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      <audio id="localAudio" autoplay muted></audio>
      <audio id="remoteAudio" autoplay></audio>
    </div>
  </div>
<script>
(() => {
  const userInput = document.getElementById('userInput');
  const usernameInput = document.getElementById('usernameInput');
  const serverInput = document.getElementById('serverInput');
  const loginBtn = document.getElementById('loginBtn');
  const status = document.getElementById('status');
  const messagesDiv = document.getElementById('messages');
  const groupTitle = document.getElementById('groupTitle');
  const inputArea = document.getElementById('inputArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const callBtn = document.getElementById('callBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  const localAudio = document.getElementById('localAudio');
  const remoteAudio = document.getElementById('remoteAudio');
  const callArea = document.getElementById('callArea');
  const themeToggle = document.getElementById('themeToggle');
  const body = document.body;

  let ws, username, userId, serverUrl;
  let connected = false;
  let localStream, peerConnection;
  const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

  const msgSound = new Audio("data:audio/wav;base64,UklGRhYAAABXQVZFZm10IBAAAAABAAEA..."); // –≤—Å—Ç–∞–≤—å —Ä–µ–∞–ª—å–Ω—ã–π base64
  const callSound = new Audio("data:audio/wav;base64,UklGRhYAAABXQVZFZm10IBAAAAABAAEA...");

  function saveCookie(key, value) {
    document.cookie = `${key}=${encodeURIComponent(value)}; path=/; max-age=31536000`;
  }

  function getCookie(key) {
    const match = document.cookie.match(new RegExp('(^| )' + key + '=([^;]+)'));
    return match ? decodeURIComponent(match[2]) : '';
  }

  function initTheme() {
    const savedTheme = getCookie('theme') || 'light';
    body.dataset.theme = savedTheme;
  }

  themeToggle.onclick = () => {
    const newTheme = body.dataset.theme === 'dark' ? 'light' : 'dark';
    body.dataset.theme = newTheme;
    saveCookie('theme', newTheme);
  };

  function requestNotificationPermission() {
    if (Notification.permission === 'default') {
      Notification.requestPermission();
    }
  }

  function showMessage(sender, text, isYou = false) {
    const div = document.createElement('div');
    div.className = 'msg ' + (isYou ? 'you' : 'other');
    div.textContent = `${sender}: ${text}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    if (!isYou) {
      msgSound.play().catch(() => {});
      if (Notification.permission === 'granted') {
        new Notification(`${sender}`, { body: text });
      }
    }
  }

  function connectWS() {
    ws = new WebSocket(serverUrl.replace(/^http/, 'ws'));
    ws.onopen = () => {
      connected = true;
      status.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
      ws.send(JSON.stringify({ type: 'login', username, userId }));
      groupTitle.textContent = `–ß–∞—Ç: –û–±—â–∏–π`;
      inputArea.style.display = 'flex';
      callArea.style.display = 'flex';
    };
    ws.onclose = () => {
      status.textContent = '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ';
      connected = false;
    };
    ws.onmessage = async (e) => {
      const data = JSON.parse(e.data);
      switch (data.type) {
        case 'message':
          showMessage(data.username, data.text, data.username === username);
          break;
        case 'signal':
          await handleSignal(data);
          break;
      }
    };
  }

  loginBtn.onclick = () => {
    userId = userInput.value.trim();
    username = usernameInput.value.trim();
    serverUrl = serverInput.value.trim();

    if (!userId || !username || !serverUrl) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }

    saveCookie('userId', userId);
    saveCookie('username', username);
    saveCookie('serverUrl', serverUrl);

    connectWS();
    requestNotificationPermission();
  };

  sendBtn.onclick = () => {
    const text = messageInput.value.trim();
    if (text && connected) {
      ws.send(JSON.stringify({ type: 'message', text }));
      showMessage(username, text, true);
      messageInput.value = '';
    }
  };

  messageInput.onkeyup = (e) => {
    if (e.key === 'Enter') sendBtn.click();
  };

  async function startCall() {
    callSound.play().catch(() => {});
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    localAudio.srcObject = localStream;
    peerConnection = new RTCPeerConnection(config);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.onicecandidate = e => {
      if (e.candidate) {
        ws.send(JSON.stringify({ type: 'signal', signalData: { candidate: e.candidate } }));
      }
    };

    peerConnection.ontrack = e => {
      remoteAudio.srcObject = e.streams[0];
    };

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);

    ws.send(JSON.stringify({ type: 'signal', signalData: { sdp: peerConnection.localDescription } }));
    hangupBtn.disabled = false;
  }

  async function handleSignal(data) {
    if (!peerConnection) {
      peerConnection = new RTCPeerConnection(config);
      peerConnection.onicecandidate = e => {
        if (e.candidate) {
          ws.send(JSON.stringify({ type: 'signal', signalData: { candidate: e.candidate } }));
        }
      };
      peerConnection.ontrack = e => {
        remoteAudio.srcObject = e.streams[0];
      };
    }

    const s = data.signalData;
    if (s.sdp) {
      await peerConnection.setRemoteDescription(new RTCSessionDescription(s.sdp));
      if (s.sdp.type === 'offer') {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localAudio.srcObject = localStream;
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: 'signal', signalData: { sdp: peerConnection.localDescription } }));
      }
    } else if (s.candidate) {
      await peerConnection.addIceCandidate(new RTCIceCandidate(s.candidate));
    }
  }

  function hangupCall() {
    if (peerConnection) peerConnection.close();
    peerConnection = null;
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
      localStream = null;
    }
    localAudio.srcObject = null;
    remoteAudio.srcObject = null;
    hangupBtn.disabled = true;
  }

  callBtn.onclick = startCall;
  hangupBtn.onclick = hangupCall;

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ cookie –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  window.addEventListener('DOMContentLoaded', () => {
    userInput.value = getCookie('userId') || '';
    usernameInput.value = getCookie('username') || '';
    serverInput.value = getCookie('serverUrl') || '';
    initTheme();
    requestNotificationPermission();
  });
})();
</script>
</body>
</html>
