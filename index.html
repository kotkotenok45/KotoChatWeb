<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>KotoChat Web</title>
<style>
body{font-family:sans-serif;margin:0;padding:0;background:#f5f5f5}
.container{width:800px;margin:20px auto}
h2{text-align:center}
#login,#chat{background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 5px #ccc}
#chat{display:none}
#messages{border:1px solid #ccc;height:400px;overflow-y:auto;padding:10px;margin-bottom:10px;display:flex;flex-direction:column}
.msg{margin:5px 0;padding:6px;border-radius:6px;max-width:70%}
.me{background:#cce5ff;align-self:flex-end}
.other{background:#d4edda;align-self:flex-start}
.row{display:flex;gap:5px;margin-top:5px}
input{flex:1;padding:6px;border:1px solid #ccc;border-radius:6px}
button{padding:6px 12px;border:none;border-radius:6px;background:#007bff;color:white;cursor:pointer}
</style>
</head>
<body>
<div class="container">
<h2>KotoChat Web</h2>

<div id="login">
<input id="username" placeholder="Логин"><br><br>
<input id="password" type="password" placeholder="Пароль"><br><br>
<button onclick="login()">Войти / Создать аккаунт</button>
</div>

<div id="chat">
<div id="messages"></div>

<div class="row">
<input id="to" placeholder="Кому">
<input id="text" placeholder="Сообщение">
<button onclick="sendMsg()">Отправить</button>
</div>

<div class="row">
<input id="groupName" placeholder="Новая группа">
<button onclick="createGroup()">Создать группу</button>
</div>

<div class="row">
<input id="addUser" placeholder="Добавить в группу">
<input id="groupTarget" placeholder="Группа">
<button onclick="addUserToGroup()">Добавить</button>
</div>

<div class="row">
<input id="roleUser" placeholder="Пользователь">
<input id="roleGroup" placeholder="Группа">
<select id="roleSelect">
<option>Участник</option>
<option>Модератор</option>
<option>Создатель</option>
</select>
<button onclick="changeRole()">Изменить роль</button>
</div>
</div>
</div>

<script>
const API="https://kotochat-e22r.onrender.com/api";
let username;

async function login(){
 username=document.getElementById("username").value;
 const password=document.getElementById("password").value;
 let res=await fetch(API+"/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,password})});
 if(res.ok){document.getElementById("login").style.display="none";document.getElementById("chat").style.display="block";loadData();setInterval(loadData,2000)}
 else{
   res=await fetch(API+"/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username,password})});
   if(res.ok){document.getElementById("login").style.display="none";document.getElementById("chat").style.display="block";loadData();setInterval(loadData,2000)}
   else alert("Ошибка");
 }
}

async function loadData(){
 const msgs=await fetch(`${API}/messages/${username}`);
 const data=await msgs.json();
 const box=document.getElementById("messages");
 box.innerHTML="";
 for(const m of data){
   const div=document.createElement("div");
   div.className="msg "+(m.from===username?"me":"other");
   div.innerText=`${m.from}: ${m.text}`;
   box.appendChild(div);
   box.scrollTop=box.scrollHeight;
 }
}

async function sendMsg(){
 const to=document.getElementById("to").value;
 const text=document.getElementById("text").value;
 if(!to||!text)return;
 await fetch(API+"/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({from:username,to,text})});
 document.getElementById("text").value="";
 loadData();
}

async function createGroup(){
 const g=document.getElementById("groupName").value;
 if(!g)return;
 await fetch(API+"/creategroup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({creator:username,name:g})});
 document.getElementById("groupName").value="";
}

async function addUserToGroup(){
 const u=document.getElementById("addUser").value;
 const g=document.getElementById("groupTarget").value;
 if(!u||!g)return;
 await fetch(API+"/addtogroup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({group:g,user:u,by:username})});
 document.getElementById("addUser").value="";document.getElementById("groupTarget").value="";
}

async function changeRole(){
 const u=document.getElementById("roleUser").value;
 const g=document.getElementById("roleGroup").value;
 const r=document.getElementById("roleSelect").value;
 if(!u||!g||!r)return;
 await fetch(API+"/changerole",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({group:g,user:u,role:r,by:username})});
 document.getElementById("roleUser").value="";document.getElementById("roleGroup").value="";
}
</script>
</body>
</html>
