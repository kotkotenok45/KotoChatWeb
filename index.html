<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KotoChat</title>
<style>
  :root { --bg:#fff;--text:#222;--accent:#2ed573;--sidebar:#2f3542;--header:#57606f;--msg-you:#70a1ff;--msg-other:#dfe4ea;--border:#ccc; }
  [data-theme="dark"] { --bg:#1e272e;--text:#fff;--accent:#1dd1a1;--sidebar:#2f3542;--header:#3742fa;--msg-you:#2ed573;--msg-other:#57606f;--border:#444; }
  body { margin:0; font-family:Arial,sans-serif; background:var(--bg); color:var(--text); display:flex; height:100vh; }
  #sidebar { width:280px; background:var(--sidebar); color:white; padding:15px; display:flex; flex-direction:column; gap:10px; }
  #sidebar input, #sidebar button, #sidebar select { padding:10px; border-radius:6px; border:none; font-size:14px; width:100%; box-sizing:border-box; }
  #sidebar button { background:var(--accent); color:white; cursor:pointer; }
  #main { flex:1; display:flex; flex-direction:column; }
  #chatHeader { background:var(--header); color:white; padding:10px; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
  #messages { flex:1; overflow-y:auto; padding:10px; background:var(--bg); }
  .msg { margin:5px 0; max-width:70%; padding:8px 14px; border-radius:16px; word-wrap:break-word; }
  .msg.you { background:var(--msg-you); color:white; align-self:flex-end; margin-left:auto; }
  .msg.other { background:var(--msg-other); color:var(--text); align-self:flex-start; margin-right:auto; }
  #inputArea, #groupsArea, #accountArea, #callArea { display:none; padding:10px; border-top:1px solid var(--border); background:var(--bg); }
  #themeToggle { font-size:13px; background:transparent; border:1px solid white; color:white; padding:5px 10px; border-radius:8px; cursor:pointer; align-self:flex-start; }
  audio { display:none; }
  #membersList { max-height:100px; overflow-y:auto; background:#444; padding:5px; border-radius:6px; font-size:13px; }
  #membersList div { display:flex; justify-content:space-between; padding:2px 5px; background:#555; margin-bottom:4px; border-radius:4px; }
  #membersList button { background:#ff6b6b; color:white; border:none; padding:2px 6px; border-radius:4px; cursor:pointer; font-size:12px; }
</style>
</head>
<body data-theme="light">
  <div id="sidebar">
    <h2>KotoChat</h2>
    <button id="themeToggle">üåó</button>
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
    <input id="username" placeholder="–ò–º—è –≤ —á–∞—Ç–µ" />
    <button id="loginBtn">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <div id="status" style="color:yellow;"></div>

    <select id="groupSelect"></select>
    <button id="joinGroupBtn">–í–æ–π—Ç–∏</button>
    <input id="newGroup" placeholder="–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞" />
    <button id="createGroupBtn">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
    <div id="membersList"></div>
    <input id="addMemberEmail" placeholder="Email —É—á–∞—Å—Ç–Ω–∏–∫–∞" />
    <button id="addMemberBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
    <div id="accountArea">
      <div><b>–ü–æ—á—Ç–∞:</b> <span id="accEmail"></span></div>
      <div><b>–ò–º—è:</b> <input id="accName" /></div>
      <div><b>–†–æ–ª—å:</b> <span id="accRole"></span></div>
      <button id="saveNameBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–º—è</button>
    </div>
  </div>
  <div id="main">
    <div id="chatHeader">–ù–µ –≤ —á–∞—Ç–µ</div>
    <div id="messages"></div>
    <div id="inputArea">
      <input id="messageInput" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <div id="callArea">
      <button id="callBtn">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
      <button id="hangupBtn" disabled>–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      <audio id="localAudio" autoplay muted></audio>
      <audio id="remoteAudio" autoplay></audio>
    </div>
  </div>

<script>
const wsUrl = document.getElementById('groupSelect');
const emailIn = document.getElementById('email');
const passIn = document.getElementById('password');
const userIn = document.getElementById('username');
const loginBtn = document.getElementById('loginBtn');
const status = document.getElementById('status');
const messages = document.getElementById('messages');
const chatHeader = document.getElementById('chatHeader');
const inputArea = document.getElementById('inputArea');
const msgIn = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const callArea = document.getElementById('callArea');
const callBtn = document.getElementById('callBtn');
const hangupBtn = document.getElementById('hangupBtn');
const localAudio = document.getElementById('localAudio');
const remoteAudio = document.getElementById('remoteAudio');
const themeToggle = document.getElementById('themeToggle');

const groupSelect = document.getElementById('groupSelect');
const joinGroupBtn = document.getElementById('joinGroupBtn');
const newGroup = document.getElementById('newGroup');
const createGroupBtn = document.getElementById('createGroupBtn');
const membersList = document.getElementById('membersList');
const addMemberEmail = document.getElementById('addMemberEmail');
const addMemberBtn = document.getElementById('addMemberBtn');
const accEmail = document.getElementById('accEmail');
const accName = document.getElementById('accName');
const accRole = document.getElementById('accRole');
const saveNameBtn = document.getElementById('saveNameBtn');

let ws, me={}, currentGroup='', pc, localStream;

function log(s){status.textContent=s}

themeToggle.onclick=()=>{
  const d=document.body.dataset.theme= document.body.dataset.theme==='dark'?'light':'dark';
  document.cookie="theme="+d+";max-age=999999";
};
(()=>{
  const m = document.cookie.match(/theme=(dark|light)/);
  document.body.dataset.theme=m?m[1]:'light';
})();

function addMessage(m){
  const d=document.createElement('div');
  d.className='msg '+(m.from===me.username?'you':'other');
  const label=m.role&&m.role!=='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'?`[${m.role}] `:'';
  d.textContent=label+m.from+': '+m.text;
  messages.appendChild(d);
  messages.scrollTop=1e9;
}

function renderMembers(arr){
  membersList.innerHTML='';
  arr.forEach(e=>{
    const d=document.createElement('div'); d.textContent=e;
    if(me.role==='–°–æ–∑–¥–∞—Ç–µ–ª—å'||me.role==='–ê–¥–º–∏–Ω'){
      const b=document.createElement('button'); b.textContent='x';
      b.onclick=()=>ws.send(JSON.stringify({type:'remove_member',group:currentGroup,email:e}));
      d.appendChild(b);
    }
    membersList.appendChild(d);
  });
}

loginBtn.onclick=()=>{
  ws=new WebSocket((location.protocol==='https:'?'wss:':'ws:')+'//'+location.host);
  ws.onopen=()=>{
    ws.send(JSON.stringify({type:'auth',email:emailIn.value,pass:passIn.value,username:userIn.value}));
  };
  ws.onmessage=e=>{
    const d=JSON.parse(e.data);
    console.log(d);
    if(d.type==='auth_ok'){
      me=d.user;
      chatHeader.textContent='–ì—Ä—É–ø–ø–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞';
      accEmail.textContent=me.email;
      accName.value=me.username;
      accRole.textContent=me.role;
      renderGroups(d.groups);
      renderMembers(d.members||[]);
      inputArea.style.display='none';
      callArea.style.display='none';
      log('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!');
    }
    if(d.type==='auth_fail'){ log('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'); ws.close(); }
    if(d.type==='groups'){
      renderGroups(d.groups);
    }
    if(d.type==='joined'){
      currentGroup=d.group;
      chatHeader.textContent=`${currentGroup} ‚Äì ${me.role}`;
      messages.innerHTML='';
      d.history.forEach(addMessage);
      renderMembers(d.members);
      inputArea.style.display='flex';
      callArea.style.display='flex';
    }
    if(d.type==='message'){ if(d.group===currentGroup)addMessage(d); }
    if(d.type==='members')renderMembers(d.members);
    if(d.type==='member_added'||d.type==='member_removed'){
      renderMembers(d.members);
    }
    if(d.type==='name_saved') log('–ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
  };
};

createGroupBtn.onclick=()=>ws.send(JSON.stringify({type:'create',group:newGroup.value}));
function renderGroups(gs){
  groupSelect.innerHTML='';
  gs.forEach(g=>{
    const o=document.createElement('option');o.text=g;o.value=g;
    groupSelect.appendChild(o);
  });
}
joinGroupBtn.onclick=()=>ws.send(JSON.stringify({type:'join_group',group:groupSelect.value}));
sendBtn.onclick=()=>{
  ws.send(JSON.stringify({type:'message',group:currentGroup,text:msgIn.value}));
  msgIn.value='';
};
addMemberBtn.onclick=()=>{
  ws.send(JSON.stringify({type:'add_member',group:currentGroup,email:addMemberEmail.value}));
  addMemberEmail.value='';
};
saveNameBtn.onclick=()=>{
  ws.send(JSON.stringify({type:'save_name',username:accName.value}));
};

let iceConfig={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
callBtn.onclick=async()=>{
  localStream=await navigator.mediaDevices.getUserMedia({audio:true});
  localAudio.srcObject=localStream;
  pc=new RTCPeerConnection(iceConfig);
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.onicecandidate=e=>e.candidate&&ws.send(JSON.stringify({type:'signal',candidate:e.candidate,group:currentGroup}));
  pc.ontrack=e=>{remoteAudio.srcObject=e.streams[0];remoteAudio.style.display='block';};
  const offer=await pc.createOffer();await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({type:'signal',sdp:pc.localDescription,group:currentGroup}));
  hangupBtn.disabled=false;
};
hangupBtn.onclick=()=>{pc.close();localStream?.getTracks().forEach(t=>t.stop());hangupBtn.disabled=true;remoteAudio.srcObject=null;};

</script>
</body>
</html>
