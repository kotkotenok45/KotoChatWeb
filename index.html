<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>KotoChat — ПК версия</title>
<meta name="description" content="KotoChat — адаптивный интерфейс для ПК. Вход: логин/пароль без подтверждения. Подключение к серверу с экраном загрузки." />
<style>
  :root {
    --bg:#071227;
    --card:#0b1630;
    --muted:#93a3b8;
    --accent:#3b82f6;
    --accent2:#06b6d4;
    --bubble-in:#0f1a2a;
    --bubble-out:linear-gradient(90deg,var(--accent),var(--accent2));
    --radius:14px;
    --gap:12px;
    --max-w:1400px;
    --text:#e9f2ff;
    --loading-size:48px;
  }
  *{box-sizing:border-box;}
  html, body {
    height: 100%; margin:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(180deg, var(--bg), #031021);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
  }
  .app {
    max-width: var(--max-w);
    margin: 0 auto;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    user-select: none;
  }
  header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 24px;
    background: var(--card);
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  .logo {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    background: linear-gradient(135deg,var(--accent),var(--accent2));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 24px;
    color: white;
    user-select: none;
  }
  .title {
    font-size: 24px;
    font-weight: 700;
  }
  main.layout {
    flex: 1;
    display: flex;
    gap: 16px;
    padding: 16px 24px;
  }
  aside.sidebar {
    flex: 0 0 360px;
    background: rgba(255,255,255,0.02);
    border-radius: 20px;
    padding: 16px;
    display: flex;
    flex-direction: column;
  }
  .search {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 12px;
  }
  .search input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 14px;
    border: none;
    background: rgba(255,255,255,0.03);
    color: var(--muted);
    font-size: 16px;
    outline: none;
  }
  .chatlist {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .chatitem {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    border-radius: 16px;
    cursor: pointer;
    transition: background 0.15s;
    user-select: none;
  }
  .chatitem:hover {
    background: rgba(59,130,246,0.12);
  }
  .chatitem.active {
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    color: #001026;
  }
  .avatar {
    flex-shrink: 0;
    width: 56px;
    height: 56px;
    border-radius: 16px;
    background: #0ea5a9;
    color: white;
    font-weight: 700;
    font-size: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
  }
  .meta {
    flex: 1;
    min-width: 0;
  }
  .name {
    font-weight: 700;
    font-size: 18px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .preview {
    color: var(--muted);
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .time {
    font-size: 13px;
    color: var(--muted);
    user-select: none;
  }
  section.chatwrap {
    flex: 1;
    background: rgba(255,255,255,0.02);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .chatHeader {
    display: flex;
    align-items: center;
    gap: 18px;
    padding: 16px 24px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    background: var(--card);
  }
  .chatHeader .title {
    font-size: 20px;
  }
  .chatHeader .subtitle {
    font-size: 14px;
    color: var(--muted);
  }
  .chatHeader .avatar {
    width: 64px;
    height: 64px;
    border-radius: 18px;
  }
  .chatHeaderButtons {
    margin-left: auto;
    display: flex;
    gap: 14px;
  }
  button.btn {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 14px;
    padding: 12px 20px;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s;
  }
  button.btn:hover {
    background: var(--accent2);
  }
  button.btn.ghost {
    background: transparent;
    border: 1.5px solid rgba(255,255,255,0.1);
    color: var(--text);
  }
  .messages {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: var(--bg);
  }
  .bubble {
    max-width: 70%;
    padding: 14px 20px;
    border-radius: var(--radius);
    word-wrap: break-word;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    user-select: text;
  }
  .bubble.in {
    align-self: flex-start;
    background: var(--bubble-in);
    color: var(--text);
    border-top-left-radius: 6px;
  }
  .bubble.out {
    align-self: flex-end;
    background: var(--bubble-out);
    color: #001026;
    border-top-right-radius: 6px;
  }
  .msgmeta {
    font-size: 13px;
    color: var(--muted);
    margin-top: 8px;
    user-select: none;
  }
  .composer {
    padding: 18px 24px;
    border-top: 1px solid rgba(255,255,255,0.05);
    display: flex;
    gap: 16px;
    background: var(--card);
  }
  .composer input {
    flex: 1;
    padding: 16px 20px;
    border-radius: 20px;
    border: none;
    background: rgba(255,255,255,0.03);
    color: var(--text);
    font-size: 18px;
    outline: none;
  }

  /* Login screen */
  #loginScreen {
    position: absolute;
    inset: 0;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }
  #loginCard {
    background: var(--card);
    border-radius: 24px;
    padding: 36px 48px;
    width: 460px;
    box-shadow: 0 0 20px rgba(0,0,0,0.7);
  }
  #loginCard h3 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 28px;
  }
  #loginCard label {
    font-size: 15px;
    color: var(--muted);
    display: block;
    margin-bottom: 8px;
  }
  #loginCard input[type=text],
  #loginCard input[type=password] {
    width: 100%;
    padding: 14px 16px;
    border-radius: 16px;
    border: none;
    background: rgba(255,255,255,0.02);
    color: var(--text);
    font-size: 18px;
    margin-bottom: 20px;
    outline: none;
  }
  #loginCard button {
    width: 100%;
    padding: 14px;
    border-radius: 18px;
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
  }
  #loginCard button.ghost {
    background: transparent;
    border: 2px solid var(--accent);
    color: var(--accent);
    margin-top: 10px;
  }
  #loginCard p.muted {
    text-align: center;
    font-size: 14px;
    color: var(--muted);
    margin-top: 16px;
  }

  /* Loading overlay */
  #loadingOverlay {
    position: fixed;
    inset: 0;
    background: rgba(7,18,39,0.85);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--accent);
    font-size: 22px;
    font-weight: 700;
    z-index: 1000;
    user-select: none;
  }
  .spinner {
    margin-top: 24px;
    border: 6px solid rgba(59,130,246,0.25);
    border-top: 6px solid var(--accent);
    border-radius: 50%;
    width: var(--loading-size);
    height: var(--loading-size);
    animation: spin 1.1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
  }

  /* Responsive */
  @media(max-width: 900px) {
    main.layout {
      flex-direction: column;
      padding: 12px 16px;
    }
    aside.sidebar {
      flex: none;
      width: 100%;
      max-height: 240px;
      overflow-x: auto;
      padding: 12px;
      border-radius: 14px;
      margin-bottom: 16px;
    }
    .chatlist {
      flex-direction: row;
      gap: 10px;
      overflow-x: auto;
      overflow-y: hidden;
      height: 100%;
    }
    section.chatwrap {
      flex: none;
      height: calc(100vh - 380px);
      border-radius: 14px;
    }
  }
</style>
</head>
<body>
<div class="app" id="app" style="position:relative;">

  <header>
    <div class="logo">K</div>
    <div class="title">KotoChat ПК</div>
  </header>

  <main class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="search">
        <input id="search" placeholder="Поиск чатов или пользователей" />
        <button id="newChatBtn" class="btn ghost" style="padding:12px 16px; font-size:16px;">Новый чат</button>
      </div>
      <div class="chatlist" id="chatlist"></div>
      <div style="margin-top: 12px; font-size: 14px; color: var(--muted); text-align: center;">
        Роли: Гость / Пользователь / Админ
      </div>
    </aside>

    <section class="chatwrap" id="chatwrap">
      <div id="chatHeader" class="chatHeader hidden">
        <div class="avatar" id="chatAvatar">G</div>
        <div style="flex:1;min-width:0">
          <div id="chatTitle" class="title">Выберите чат</div>
          <div id="chatSub" class="subtitle"></div>
        </div>
        <div class="chatHeaderButtons">
          <button id="callBtn" class="btn ghost">Звонок</button>
          <button id="infoBtn" class="btn ghost">Инфо</button>
          <button id="logoutBtn" class="btn ghost" style="color: var(--accent);">Выйти</button>
        </div>
      </div>
      <div id="messages" class="messages" aria-live="polite"></div>
      <div id="composer" class="composer hidden">
        <input id="msgInput" placeholder="Напишите сообщение..." autocomplete="off" />
        <button id="sendBtn" class="btn">Отправить</button>
      </div>
    </section>

  </main>

  <div id="loadingOverlay">
    Подключение...
    <div class="spinner"></div>
  </div>

  <div id="loginScreen" style="display:none;position:absolute; inset:0; background: var(--bg); z-index: 1500; align-items:center; justify-content:center; flex-direction: column;">
    <div id="loginCard">
      <h3>Вход в KotoChat</h3>
      <label for="loginName">Логин/Имя</label>
      <input id="loginName" type="text" placeholder="Имя пользователя" autocomplete="username" />
      <label for="loginPass">Пароль</label>
      <input id="loginPass" type="password" placeholder="Пароль" autocomplete="current-password" />
      <button id="loginBtn">Войти</button>
      <button id="guestBtn" class="ghost">Войти как гость</button>
      <p class="muted" style="margin-top:12px; text-align:center; font-size: 14px; color: var(--muted);">Авторизация — только имя и пароль (без подтверждения)</p>
    </div>
  </div>

</div>

<script>
const WS_SERVER = "wss://kotochat-e22r.onrender.com/ws"; // <- замени на свой WebSocket сервер
let socket = null;
let connected = false;

const state = {
  logged: false,
  user: null,
  chats: [],
  messages: {},
  activeChat: null
};

const $ = sel => document.querySelector(sel);

const chatlistEl = $('#chatlist');
const messagesEl = $('#messages');
const chatHeader = $('#chatHeader');
const chatTitle = $('#chatTitle');
const chatSub = $('#chatSub');
const chatAvatar = $('#chatAvatar');
const composerEl = $('#composer');
const msgInput = $('#msgInput');
const sendBtn = $('#sendBtn');
const logoutBtn = $('#logoutBtn');
const loginScreen = $('#loginScreen');
const loginBtn = $('#loginBtn');
const guestBtn = $('#guestBtn');
const loginName = $('#loginName');
const loginPass = $('#loginPass');
const loadingOverlay = $('#loadingOverlay');
const searchInput = $('#search');
const newChatBtn = $('#newChatBtn');

/* Utility */
function el(tag, attrs = {}, children = []) {
  const e = document.createElement(tag);
  for (const k in attrs) {
    if (k.startsWith('on')) e.addEventListener(k.slice(2), attrs[k]);
    else if (k === 'html') e.innerHTML = attrs[k];
    else e.setAttribute(k, attrs[k]);
  }
  if (typeof children === 'string') e.textContent = children;
  else (children || []).forEach(c => e.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
  return e;
}
function fmtTime(ts) {
  const d = new Date(ts);
  return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
}

/* Rendering */
function renderChatList() {
  chatlistEl.innerHTML = '';
  const filter = (searchInput.value || '').toLowerCase();
  state.chats.filter(c =>
    !filter || (c.title || '').toLowerCase().includes(filter) || (c.preview || '').toLowerCase().includes(filter)
  ).forEach(chat => {
    const item = el('div', {
      class: 'chatitem' + (state.activeChat === chat.id ? ' active' : ''),
      onclick: () => openChat(chat.id)
    }, [
      el('div', { class: 'avatar' }, chat.avatar || (chat.title ? chat.title[0].toUpperCase() : '?')),
      el('div', { class: 'meta' }, [
        el('div', { class: 'name' }, chat.title || 'Чат'),
        el('div', { class: 'preview' }, chat.preview || '')
      ]),
      el('div', { class: 'time' }, chat.unread ? String(chat.unread) : '')
    ]);
    chatlistEl.appendChild(item);
  });
}
function renderMessages(chatId) {
  messagesEl.innerHTML = '';
  const msgs = state.messages[chatId] || [];
  msgs.forEach(m => {
    const b = el('div', { class: 'bubble ' + (m.out ? 'out' : 'in') }, [
      el('div', {}, m.text),
      el('div', { class: 'msgmeta' }, (m.from ? m.from + ' · ' : '') + fmtTime(m.time))
    ]);
    messagesEl.appendChild(b);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
function openChat(chatId) {
  if (state.activeChat === chatId) return;
  state.activeChat = chatId;
  renderChatList();
  renderMessages(chatId);
  const chat = state.chats.find(c => c.id === chatId);
  if (!chat) {
    chatTitle.textContent = "Чат не найден";
    chatSub.textContent = "";
    chatAvatar.textContent = "?";
    composerEl.classList.add('hidden');
    chatHeader.classList.remove('hidden');
    return;
  }
  chatTitle.textContent = chat.title || 'Чат';
  chatSub.textContent = chat.subtitle || "";
  chatAvatar.textContent = chat.avatar || (chat.title ? chat.title[0].toUpperCase() : '?');
  composerEl.classList.remove('hidden');
  chatHeader.classList.remove('hidden');
}

/* Socket connection and messaging */
function connectSocket(token) {
  if(socket) socket.close();
  socket = new WebSocket(WS_SERVER);
  loadingOverlay.style.display = 'flex';

  socket.onopen = () => {
    connected = true;
    loadingOverlay.style.display = 'none';
    loginScreen.style.display = 'none';
    state.logged = true;
    // Авторизация (отправка токена/логина)
    socket.send(JSON.stringify({type:'auth', token}));
  };

  socket.onmessage = e => {
    const msg = JSON.parse(e.data);
    switch(msg.type) {
      case 'auth_result':
        if(msg.success) {
          state.user = msg.user;
          state.chats = msg.chats || [];
          state.messages = msg.messages || {};
          renderChatList();
          if(state.chats.length) openChat(state.chats[0].id);
          else openChat(null);
        } else {
          alert("Ошибка авторизации: " + (msg.error || "Неизвестная ошибка"));
          logout();
        }
        break;
      case 'new_message':
        if(!state.messages[msg.chatId]) state.messages[msg.chatId] = [];
        state.messages[msg.chatId].push(msg.message);
        if(state.activeChat === msg.chatId) renderMessages(msg.chatId);
        else {
          const chat = state.chats.find(c => c.id === msg.chatId);
          if(chat) chat.unread = (chat.unread || 0) + 1;
          renderChatList();
        }
        break;
      case 'chat_list_update':
        state.chats = msg.chats;
        renderChatList();
        break;
      default:
        console.log("Сообщение сервера:", msg);
    }
  };

  socket.onclose = () => {
    connected = false;
    loadingOverlay.style.display = 'none';
    loginScreen.style.display = 'flex';
    state.logged = false;
    state.user = null;
    state.chats = [];
    state.messages = {};
    renderChatList();
    messagesEl.innerHTML = '';
    chatHeader.classList.add('hidden');
    composerEl.classList.add('hidden');
  };

  socket.onerror = (e) => {
    console.error("WebSocket error", e);
  };
}

function sendMessage() {
  if(!connected || !state.activeChat) return;
  const text = msgInput.value.trim();
  if(!text) return;
  const msg = {
    type: "send_message",
    chatId: state.activeChat,
    text
  };
  socket.send(JSON.stringify(msg));
  msgInput.value = "";
}

/* Event listeners */
sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keydown', e => {
  if(e.key === 'Enter') sendMessage();
});
logoutBtn.addEventListener('click', logout);

loginBtn.addEventListener('click', () => {
  const login = loginName.value.trim();
  const pass = loginPass.value.trim();
  if(!login || !pass) {
    alert("Введите логин и пароль");
    return;
  }
  // Отправляем имя + пароль как токен (упрощенно)
  connectSocket(btoa(login + ":" + pass));
});
guestBtn.addEventListener('click', () => {
  connectSocket("guest");
});

searchInput.addEventListener('input', renderChatList);
newChatBtn.addEventListener('click', () => {
  const title = prompt("Название нового чата:");
  if(!title) return;
  // Отправляем запрос на создание нового чата
  if(!connected) return alert("Нет подключения");
  socket.send(JSON.stringify({type:"new_chat", title}));
});

function logout() {
  if(socket) {
    socket.close();
    socket = null;
  }
  state.logged = false;
  loginScreen.style.display = 'flex';
  chatHeader.classList.add('hidden');
  composerEl.classList.add('hidden');
  chatlistEl.innerHTML = '';
  messagesEl.innerHTML = '';
}

/* Init: показываем логин */
loginScreen.style.display = 'flex';
loadingOverlay.style.display = 'none';

</script>
</body>
</html>
