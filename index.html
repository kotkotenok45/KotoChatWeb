<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KotoChat</title>
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background: #f0f0f0; }
    #sidebar { width: 250px; padding: 10px; background: #ddd; display: flex; flex-direction: column; gap: 10px; }
    #main { flex: 1; display: flex; flex-direction: column; }
    #messages { flex: 1; padding: 10px; overflow-y: auto; background: #fff; }
    input, button { padding: 5px; font-size: 16px; }
    #chatInput { width: calc(100% - 110px); }
    @media (max-width: 768px) {
      body { flex-direction: column; }
      #sidebar { width: 100%; flex-direction: row; flex-wrap: wrap; justify-content: space-between; gap: 5px; }
      #sidebar input, #sidebar button { flex: 1 1 48%; }
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <input id="usernameInput" placeholder="Имя / Email" />
    <input id="passwordInput" placeholder="Пароль" type="password" />
    <button id="loginBtn">Войти</button>
    <button id="logoutBtn" style="display:none;">Выйти</button>
  </div>
  <div id="main">
    <div id="messages"></div>
    <form id="chatForm" style="display:none;">
      <input id="chatInput" placeholder="Сообщение" autocomplete="off" />
      <button>Отправить</button>
    </form>
  </div>

  <script>
    const usernameInput = document.getElementById('usernameInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const messages = document.getElementById('messages');

    let ws;

    loginBtn.onclick = () => {
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      if (!username) return alert("Введите имя!");
      ws = new WebSocket("wss://kotochat-e22r.onrender.com"); // Авто вставка ws
      ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'join', username, userId: username, password }));
        chatForm.style.display = "flex";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "block";
      };
      ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.type === 'message') {
          const div = document.createElement('div');
          div.innerHTML = `<b>[${data.role}] ${data.username}:</b> ${data.text}`;
          messages.appendChild(div);
          messages.scrollTop = messages.scrollHeight;
        } else if (data.type === 'notification') {
          const div = document.createElement('div');
          div.innerHTML = `<i>${data.text}</i>`;
          messages.appendChild(div);
        }
      };
      ws.onclose = () => {
        chatForm.style.display = "none";
        loginBtn.style.display = "block";
        logoutBtn.style.display = "none";
      };
    };

    logoutBtn.onclick = () => {
      ws.close();
    };

    chatForm.onsubmit = (e) => {
      e.preventDefault();
      if (chatInput.value.trim()) {
        ws.send(JSON.stringify({ type: 'message', text: chatInput.value }));
        chatInput.value = '';
      }
    };
  </script>
</body>
</html>
