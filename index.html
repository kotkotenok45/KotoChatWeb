<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KotoChatWeb - PC</title>
<style>
body { margin:0; font-family: Arial, sans-serif; background:#e5ddd5; display:flex; flex-direction:column; height:100vh; }
header { background:#075E54; color:white; padding:15px; font-size:24px; text-align:center; }
nav { display:flex; background:#128C7E; }
nav button { flex:1; padding:10px; border:none; background:#128C7E; color:white; font-size:16px; cursor:pointer; }
nav button.active { background:#25D366; color:white; }
section { display:none; flex:1; overflow-y:auto; padding:15px; background:#ece5dd; }
section.active { display:flex; flex-direction:column; }
#messages { flex:1; overflow-y:auto; }
#messages div { margin-bottom:10px; background:white; padding:8px; border-radius:5px; max-width:60%; }
#inputArea { display:flex; margin-top:10px; }
#inputArea input { flex:1; padding:10px; border-radius:20px; border:1px solid #ccc; }
#inputArea button { margin-left:10px; padding:10px 20px; border:none; border-radius:20px; background:#25D366; color:white; cursor:pointer; }
#inputArea button:hover { background:#128C7E; }
.dark { background:#1c1c1c; color:#eee; }
.dark section { background:#2a2a2a; }
.dark #messages div { background:#075E54; color:white; }
</style>
</head>
<body>
<header>KotoChatWeb</header>
<nav>
  <button class="active" onclick="showTab('chats')">Чаты</button>
  <button onclick="showTab('groups')">Группы</button>
  <button onclick="showTab('account')">Аккаунт</button>
</nav>

<section id="chats" class="active">
  <div id="messages"></div>
  <div id="inputArea">
    <input type="text" id="messageInput" placeholder="Введите сообщение">
    <button onclick="sendMessage()">Отправить</button>
  </div>
</section>

<section id="groups"><p>Группы пока пусты</p></section>
<section id="account">
  <p>Имя пользователя: <span id="usernameDisplay"></span></p>
  <input type="text" id="usernameInput" placeholder="Введите имя">
  <button onclick="setUsername()">Сохранить имя</button>
  <button onclick="toggleTheme()">Сменить тему</button>
</section>

<script>
let currentTheme = 'light';
function showTab(tab) {
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  document.querySelector(`button[onclick="showTab('${tab}')"]`).classList.add('active');
  document.getElementById(tab).classList.add('active');
}

function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )'+name+'=([^;]+)'));
  return match ? match[2] : '';
}
function setCookie(name,value,days=365){document.cookie=name+'='+value+';max-age='+days*24*60*60;}

function setUsername(){
  const name = document.getElementById('usernameInput').value.trim();
  if(!name) return alert('Введите имя');
  setCookie('username', name);
  document.getElementById('usernameDisplay').textContent = name;
}

document.getElementById('usernameDisplay').textContent = getCookie('username') || 'Гость';

function toggleTheme(){
  if(currentTheme==='light'){document.body.classList.add('dark'); currentTheme='dark';}
  else{document.body.classList.remove('dark'); currentTheme='light';}
}

// Чат
const messagesDiv = document.getElementById('messages');
const input = document.getElementById('messageInput');

async function loadMessages(){
  try{
    const res = await fetch('https://kotochat-e22r.onrender.com/messages/kotochat');
    if(!res.ok) throw new Error('Ошибка');
    const data = await res.json();
    messagesDiv.innerHTML='';
    data.forEach(msg=>{
      const div=document.createElement('div');
      div.textContent=msg.user + ': ' + msg.text;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  } catch(e){ console.error(e); messagesDiv.innerHTML='<div style="color:red;">Не удалось загрузить сообщения</div>'; }
}

async function sendMessage(){
  const text = input.value.trim();
  if(!text) return;
  const username = getCookie('username') || 'Гость';
  try{
    await fetch('https://kotochat-e22r.onrender.com/send',{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({user:username,text})
    });
    input.value=''; loadMessages();
  } catch(e){console.error(e);}
}

setInterval(loadMessages,3000);
loadMessages();
</script>
</body>
</html>
