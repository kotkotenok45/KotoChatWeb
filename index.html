<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KotoChat WhatsApp Style</title>
<style>
  /* ===== –°—Ç–∏–ª–∏ –≤ —Å—Ç–∏–ª–µ WhatsApp Web ===== */
  :root {
    --bg: #f0f2f5;
    --chat-bg: #ffffff;
    --header-bg: #075e54;
    --accent: #25d366;
    --text-primary: #222;
    --text-secondary: #777;
    --msg-you-bg: #dcf8c6;
    --msg-other-bg: #fff;
    --border: #ddd;
  }
  [data-theme="dark"] {
    --bg: #121c21;
    --chat-bg: #202c33;
    --header-bg: #111b21;
    --accent: #25d366;
    --text-primary: #ddd;
    --text-secondary: #bbb;
    --msg-you-bg: #054640;
    --msg-other-bg: #2a3942;
    --border: #333;
  }
  body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    overflow: hidden;
  }
  #sidebar {
    width: 320px;
    background: var(--header-bg);
    color: white;
    display: flex;
    flex-direction: column;
    padding: 20px;
  }
  #sidebar h2 {
    margin: 0 0 15px 0;
    font-weight: 700;
  }
  #sidebar input, #sidebar button {
    margin-bottom: 10px;
    padding: 12px;
    border-radius: 20px;
    border: none;
    font-size: 15px;
    box-sizing: border-box;
  }
  #sidebar input {
    width: 100%;
  }
  #sidebar button {
    background: var(--accent);
    cursor: pointer;
    font-weight: 700;
    transition: background 0.3s;
  }
  #sidebar button:hover {
    background: #1ebe57;
  }
  #status {
    margin-top: auto;
    font-size: 14px;
    min-height: 20px;
  }
  #themeToggle {
    background: transparent;
    border: 1px solid white;
    color: white;
    border-radius: 20px;
    padding: 8px 0;
    cursor: pointer;
    font-weight: 600;
  }
  #chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--chat-bg);
  }
  #chatHeader {
    background: var(--header-bg);
    color: white;
    font-weight: 600;
    font-size: 18px;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
  }
  #messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .msg {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 15px;
    box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    position: relative;
    word-break: break-word;
  }
  .msg.you {
    align-self: flex-end;
    background: var(--msg-you-bg);
  }
  .msg.other {
    align-self: flex-start;
    background: var(--msg-other-bg);
  }
  .msg .username {
    font-weight: 700;
    margin-bottom: 3px;
    font-size: 13px;
    color: var(--text-secondary);
  }
  #inputArea {
    display: flex;
    padding: 10px 20px;
    border-top: 1px solid var(--border);
    background: var(--chat-bg);
  }
  #messageInput {
    flex: 1;
    padding: 12px 15px;
    border-radius: 25px;
    border: 1px solid var(--border);
    font-size: 15px;
    outline: none;
  }
  #sendBtn {
    margin-left: 10px;
    padding: 0 18px;
    background: var(--accent);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 20px;
    cursor: pointer;
    transition: background 0.3s;
  }
  #sendBtn:hover {
    background: #1ebe57;
  }
  #callControls {
    display: flex;
    gap: 15px;
    padding: 10px 20px;
    border-top: 1px solid var(--border);
    background: var(--chat-bg);
  }
  #callBtn, #hangupBtn {
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 700;
    cursor: pointer;
    border: none;
    font-size: 16px;
    transition: background 0.3s;
  }
  #callBtn {
    background: var(--accent);
    color: white;
  }
  #callBtn:hover {
    background: #1ebe57;
  }
  #hangupBtn {
    background: #e74c3c;
    color: white;
  }
  #hangupBtn:disabled {
    background: #aaa;
    cursor: default;
  }
  audio {
    display: none;
  }
</style>
</head>
<body data-theme="light">
  <div id="sidebar">
    <h2>KotoChat</h2>
    <input id="userIdInput" placeholder="Email –∏–ª–∏ ID" autocomplete="off" />
    <input id="usernameInput" placeholder="–ò–º—è –≤ —á–∞—Ç–µ" autocomplete="off" />
    <input id="serverInput" placeholder="WebSocket URL" autocomplete="off" value="ws://localhost:10000" />
    <button id="loginBtn">–í–æ–π—Ç–∏</button>
    <div id="status"></div>
    <button id="themeToggle">üåô –¢–µ–º–∞</button>
  </div>

  <div id="chat">
    <div id="chatHeader">–ù–µ –≤ —á–∞—Ç–µ</div>
    <div id="messages"></div>
    <div id="inputArea" style="display:none;">
      <input id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
      <button id="sendBtn">‚ñ∂</button>
    </div>
    <div id="callControls" style="display:none;">
      <button id="callBtn">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
      <button id="hangupBtn" disabled>üî¥ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      <audio id="localAudio" autoplay muted></audio>
      <audio id="remoteAudio" autoplay></audio>
    </div>
  </div>

<script>
(() => {
  const userIdInput = document.getElementById('userIdInput');
  const usernameInput = document.getElementById('usernameInput');
  const serverInput = document.getElementById('serverInput');
  const loginBtn = document.getElementById('loginBtn');
  const status = document.getElementById('status');
  const messagesDiv = document.getElementById('messages');
  const chatHeader = document.getElementById('chatHeader');
  const inputArea = document.getElementById('inputArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const callControls = document.getElementById('callControls');
  const callBtn = document.getElementById('callBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  const localAudio = document.getElementById('localAudio');
  const remoteAudio = document.getElementById('remoteAudio');
  const themeToggle = document.getElementById('themeToggle');
  const body = document.body;

  let ws;
  let username = '';
  let userId = '';
  let connected = false;
  let localStream = null;
  let peerConnection = null;
  const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

  function addMessage(usernameMsg, text, isYou) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('msg', isYou ? 'you' : 'other');
    if (!isYou) {
      const userLabel = document.createElement('div');
      userLabel.textContent = usernameMsg;
      userLabel.classList.add('username');
      msgDiv.appendChild(userLabel);
    }
    const textNode = document.createElement('div');
    textNode.textContent = text;
    msgDiv.appendChild(textNode);
    messagesDiv.appendChild(msgDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function setStatus(text) {
    status.textContent = text;
  }

  function connect() {
    ws = new WebSocket(serverInput.value.trim());
    ws.onopen = () => {
      connected = true;
      setStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
      ws.send(JSON.stringify({ type: 'join', username, userId }));
      chatHeader.textContent = `–ß–∞—Ç ‚Äî ${username}`;
      inputArea.style.display = 'flex';
      callControls.style.display = 'flex';
      messageInput.focus();
    };
    ws.onmessage = async (event) => {
      let data;
      try { data = JSON.parse(event.data); } catch { return; }
      if (data.type === 'message') {
        addMessage(data.username, data.text, data.username === username);
      } else if (data.type === 'notification') {
        addMessage('–°–∏—Å—Ç–µ–º–∞', data.text, false);
      } else if (data.type === 'signal') {
        await handleSignal(data.signalData);
      } else if (data.type === 'history' && Array.isArray(data.messages)) {
        for (const msg of data.messages) {
          addMessage(msg.username, msg.text, msg.username === username);
        }
      }
    };
    ws.onclose = () => {
      connected = false;
      setStatus('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ');
      chatHeader.textContent = '–ù–µ –≤ —á–∞—Ç–µ';
      inputArea.style.display = 'none';
      callControls.style.display = 'none';
    };
    ws.onerror = () => {
      setStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    };
  }

  loginBtn.onclick = () => {
    userId = userIdInput.value.trim();
    username = usernameInput.value.trim();
    if (!userId || !username) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }
    connect();
  };

  sendBtn.onclick = () => {
    const text = messageInput.value.trim();
    if (text && connected && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'message', text }));
      addMessage(username, text, true);
      messageInput.value = '';
      messageInput.focus();
    }
  };

  messageInput.onkeyup = e => {
    if (e.key === 'Enter') sendBtn.click();
  };

  async function startCall() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localAudio.srcObject = localStream;

      peerConnection = new RTCPeerConnection(config);

      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.onicecandidate = event => {
        if (event.candidate && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'signal', signalData: { candidate: event.candidate } }));
        }
      };

      peerConnection.ontrack = event => {
        remoteAudio.srcObject = event.streams[0];
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      ws.send(JSON.stringify({ type: 'signal', signalData: { sdp: peerConnection.localDescription } }));

      hangupBtn.disabled = false;
      callBtn.disabled = true;
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫: ' + err.message);
    }
  }

  async function handleSignal(signalData) {
    if (!peerConnection) {
      peerConnection = new RTCPeerConnection(config);
      peerConnection.onicecandidate = event => {
        if (event.candidate && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'signal', signalData: { candidate: event.candidate } }));
        }
      };
      peerConnection.ontrack = event => {
        remoteAudio.srcObject = event.streams[0];
      };
    }

    if (signalData.sdp) {
      const remoteDesc = new RTCSessionDescription(signalData.sdp);
      await peerConnection.setRemoteDescription(remoteDesc);

      if (remoteDesc.type === 'offer') {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          localAudio.srcObject = localStream;
          localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        } catch {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
          return;
        }
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        ws.send(JSON.stringify({ type: 'signal', signalData: { sdp: peerConnection.localDescription } }));
      }
    } else if (signalData.candidate) {
      try {
        await peerConnection.addIceCandidate(new RTCIceCandidate(signalData.candidate));
      } catch (err) {
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞:', err);
      }
    }
  }

  hangupBtn.onclick = () => {
    if (peerConnection) peerConnection.close();
    peerConnection = null;
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
      localStream = null;
    }
    localAudio.srcObject = null;
    remoteAudio.srcObject = null;
    hangupBtn.disabled = true;
    callBtn.disabled = false;
  };

  callBtn.onclick = startCall;

  themeToggle.onclick = () => {
    body.dataset.theme = body.dataset.theme === 'dark' ? 'light' : 'dark';
  };
})();
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KotoChat WhatsApp Style</title>
<style>
  /* ===== –°—Ç–∏–ª–∏ –≤ —Å—Ç–∏–ª–µ WhatsApp Web ===== */
  :root {
    --bg: #f0f2f5;
    --chat-bg: #ffffff;
    --header-bg: #075e54;
    --accent: #25d366;
    --text-primary: #222;
    --text-secondary: #777;
    --msg-you-bg: #dcf8c6;
    --msg-other-bg: #fff;
    --border: #ddd;
  }
  [data-theme="dark"] {
    --bg: #121c21;
    --chat-bg: #202c33;
    --header-bg: #111b21;
    --accent: #25d366;
    --text-primary: #ddd;
    --text-secondary: #bbb;
    --msg-you-bg: #054640;
    --msg-other-bg: #2a3942;
    --border: #333;
  }
  body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg);
    color: var(--text-primary);
    height: 100vh;
    display: flex;
    overflow: hidden;
  }
  #sidebar {
    width: 320px;
    background: var(--header-bg);
    color: white;
    display: flex;
    flex-direction: column;
    padding: 20px;
  }
  #sidebar h2 {
    margin: 0 0 15px 0;
    font-weight: 700;
  }
  #sidebar input, #sidebar button {
    margin-bottom: 10px;
    padding: 12px;
    border-radius: 20px;
    border: none;
    font-size: 15px;
    box-sizing: border-box;
  }
  #sidebar input {
    width: 100%;
  }
  #sidebar button {
    background: var(--accent);
    cursor: pointer;
    font-weight: 700;
    transition: background 0.3s;
  }
  #sidebar button:hover {
    background: #1ebe57;
  }
  #status {
    margin-top: auto;
    font-size: 14px;
    min-height: 20px;
  }
  #themeToggle {
    background: transparent;
    border: 1px solid white;
    color: white;
    border-radius: 20px;
    padding: 8px 0;
    cursor: pointer;
    font-weight: 600;
  }
  #chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--chat-bg);
  }
  #chatHeader {
    background: var(--header-bg);
    color: white;
    font-weight: 600;
    font-size: 18px;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
  }
  #messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .msg {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 15px;
    box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    position: relative;
    word-break: break-word;
  }
  .msg.you {
    align-self: flex-end;
    background: var(--msg-you-bg);
  }
  .msg.other {
    align-self: flex-start;
    background: var(--msg-other-bg);
  }
  .msg .username {
    font-weight: 700;
    margin-bottom: 3px;
    font-size: 13px;
    color: var(--text-secondary);
  }
  #inputArea {
    display: flex;
    padding: 10px 20px;
    border-top: 1px solid var(--border);
    background: var(--chat-bg);
  }
  #messageInput {
    flex: 1;
    padding: 12px 15px;
    border-radius: 25px;
    border: 1px solid var(--border);
    font-size: 15px;
    outline: none;
  }
  #sendBtn {
    margin-left: 10px;
    padding: 0 18px;
    background: var(--accent);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 20px;
    cursor: pointer;
    transition: background 0.3s;
  }
  #sendBtn:hover {
    background: #1ebe57;
  }
  #callControls {
    display: flex;
    gap: 15px;
    padding: 10px 20px;
    border-top: 1px solid var(--border);
    background: var(--chat-bg);
  }
  #callBtn, #hangupBtn {
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 700;
    cursor: pointer;
    border: none;
    font-size: 16px;
    transition: background 0.3s;
  }
  #callBtn {
    background: var(--accent);
    color: white;
  }
  #callBtn:hover {
    background: #1ebe57;
  }
  #hangupBtn {
    background: #e74c3c;
    color: white;
  }
  #hangupBtn:disabled {
    background: #aaa;
    cursor: default;
  }
  audio {
    display: none;
  }
</style>
</head>
<body data-theme="light">
  <div id="sidebar">
    <h2>KotoChat</h2>
    <input id="userIdInput" placeholder="Email –∏–ª–∏ ID" autocomplete="off" />
    <input id="usernameInput" placeholder="–ò–º—è –≤ —á–∞—Ç–µ" autocomplete="off" />
    <input id="serverInput" placeholder="WebSocket URL" autocomplete="off" value="ws://localhost:10000" />
    <button id="loginBtn">–í–æ–π—Ç–∏</button>
    <div id="status"></div>
    <button id="themeToggle">üåô –¢–µ–º–∞</button>
  </div>

  <div id="chat">
    <div id="chatHeader">–ù–µ –≤ —á–∞—Ç–µ</div>
    <div id="messages"></div>
    <div id="inputArea" style="display:none;">
      <input id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
      <button id="sendBtn">‚ñ∂</button>
    </div>
    <div id="callControls" style="display:none;">
      <button id="callBtn">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
      <button id="hangupBtn" disabled>üî¥ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      <audio id="localAudio" autoplay muted></audio>
      <audio id="remoteAudio" autoplay></audio>
    </div>
  </div>

<script>
(() => {
  const userIdInput = document.getElementById('userIdInput');
  const usernameInput = document.getElementById('usernameInput');
  const serverInput = document.getElementById('serverInput');
  const loginBtn = document.getElementById('loginBtn');
  const status = document.getElementById('status');
  const messagesDiv = document.getElementById('messages');
  const chatHeader = document.getElementById('chatHeader');
  const inputArea = document.getElementById('inputArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const callControls = document.getElementById('callControls');
  const callBtn = document.getElementById('callBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  const localAudio = document.getElementById('localAudio');
  const remoteAudio = document.getElementById('remoteAudio');
  const themeToggle = document.getElementById('themeToggle');
  const body = document.body;

  let ws;
  let username = '';
  let userId = '';
  let connected = false;
  let localStream = null;
  let peerConnection = null;
  const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

  function addMessage(usernameMsg, text, isYou) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('msg', isYou ? 'you' : 'other');
    if (!isYou) {
      const userLabel = document.createElement('div');
      userLabel.textContent = usernameMsg;
      userLabel.classList.add('username');
      msgDiv.appendChild(userLabel);
    }
    const textNode = document.createElement('div');
    textNode.textContent = text;
    msgDiv.appendChild(textNode);
    messagesDiv.appendChild(msgDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function setStatus(text) {
    status.textContent = text;
  }

  function connect() {
    ws = new WebSocket(serverInput.value.trim());
    ws.onopen = () => {
      connected = true;
      setStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
      ws.send(JSON.stringify({ type: 'join', username, userId }));
      chatHeader.textContent = `–ß–∞—Ç ‚Äî ${username}`;
      inputArea.style.display = 'flex';
      callControls.style.display = 'flex';
      messageInput.focus();
    };
    ws.onmessage = async (event) => {
      let data;
      try { data = JSON.parse(event.data); } catch { return; }
      if (data.type === 'message') {
        addMessage(data.username, data.text, data.username === username);
      } else if (data.type === 'notification') {
        addMessage('–°–∏—Å—Ç–µ–º–∞', data.text, false);
      } else if (data.type === 'signal') {
        await handleSignal(data.signalData);
      } else if (data.type === 'history' && Array.isArray(data.messages)) {
        for (const msg of data.messages) {
          addMessage(msg.username, msg.text, msg.username === username);
        }
      }
    };
    ws.onclose = () => {
      connected = false;
      setStatus('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ');
      chatHeader.textContent = '–ù–µ –≤ —á–∞—Ç–µ';
      inputArea.style.display = 'none';
      callControls.style.display = 'none';
    };
    ws.onerror = () => {
      setStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    };
  }

  loginBtn.onclick = () => {
    userId = userIdInput.value.trim();
    username = usernameInput.value.trim();
    if (!userId || !username) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }
    connect();
  };

  sendBtn.onclick = () => {
    const text = messageInput.value.trim();
    if (text && connected && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'message', text }));
      addMessage(username, text, true);
      messageInput.value = '';
      messageInput.focus();
    }
  };

  messageInput.onkeyup = e => {
    if (e.key === 'Enter') sendBtn.click();
  };

  async function startCall() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localAudio.srcObject = localStream;

      peerConnection = new RTCPeerConnection(config);

      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.onicecandidate = event => {
        if (event.candidate && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'signal', signalData: { candidate: event.candidate } }));
        }
      };

      peerConnection.ontrack = event => {
        remoteAudio.srcObject = event.streams[0];
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      ws.send(JSON.stringify({ type: 'signal', signalData: { sdp: peerConnection.localDescription } }));

      hangupBtn.disabled = false;
      callBtn.disabled = true;
    } catch (err) {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫: ' + err.message);
    }
  }

  async function handleSignal(signalData) {
    if (!peerConnection) {
      peerConnection = new RTCPeerConnection(config);
      peerConnection.onicecandidate = event => {
        if (event.candidate && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'signal', signalData: { candidate: event.candidate } }));
        }
      };
      peerConnection.ontrack = event => {
        remoteAudio.srcObject = event.streams[0];
      };
    }

    if (signalData.sdp) {
      const remoteDesc = new RTCSessionDescription(signalData.sdp);
      await peerConnection.setRemoteDescription(remoteDesc);

      if (remoteDesc.type === 'offer') {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          localAudio.srcObject = localStream;
          localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        } catch {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
          return;
        }
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        ws.send(JSON.stringify({ type: 'signal', signalData: { sdp: peerConnection.localDescription } }));
      }
    } else if (signalData.candidate) {
      try {
        await peerConnection.addIceCandidate(new RTCIceCandidate(signalData.candidate));
      } catch (err) {
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ ICE-–∫–∞–Ω–¥–∏–¥–∞—Ç–∞:', err);
      }
    }
  }

  hangupBtn.onclick = () => {
    if (peerConnection) peerConnection.close();
    peerConnection = null;
    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
      localStream = null;
    }
    localAudio.srcObject = null;
    remoteAudio.srcObject = null;
    hangupBtn.disabled = true;
    callBtn.disabled = false;
  };

  callBtn.onclick = startCall;

  themeToggle.onclick = () => {
    body.dataset.theme = body.dataset.theme === 'dark' ? 'light' : 'dark';
  };
})();
</script>

</body>
</html>
