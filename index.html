<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
<style>
  :root {
    --sidebar-bg: #2f3542;
    --main-bg: #f1f2f6;
    --header-bg: #57606f;
    --input-bg: #dfe4ea;
    --you-msg-bg: #70a1ff;
    --other-msg-bg: #dfe4ea;
    --btn-primary: #3742fa;
    --btn-success: #2ed573;
    --btn-danger: #ff6b6b;
    --text-light: white;
    --text-dark: #2f3542;
    --border-radius: 15px;
    --shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }

  #sidebar {
    width: 260px;
    background: var(--sidebar-bg);
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    padding: 16px;
    box-shadow: var(--shadow);
    overflow-y: auto;
  }

  #sidebar h3 {
    margin-top: 0;
    margin-bottom: 16px;
    font-size: 1.3rem;
    text-align: center;
  }

  #sidebar input, #sidebar button {
    margin-top: 8px;
    padding: 10px 12px;
    border-radius: 8px;
    border: none;
    font-size: 14px;
  }

  #sidebar input {
    width: 100%;
    background: rgba(255,255,255,0.1);
    color: white;
    border: 1px solid rgba(255,255,255,0.2);
  }

  #sidebar input::placeholder {
    color: rgba(255,255,255,0.6);
  }

  #sidebar input:focus {
    outline: 1px solid rgba(255,255,255,0.4);
  }

  #sidebar button {
    background: var(--btn-primary);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  #sidebar button:hover:not(:disabled) {
    background: #2c39da;
  }

  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--main-bg);
  }

  #chatHeader {
    background: var(--header-bg);
    color: var(--text-light);
    padding: 12px 16px;
    font-size: 1.1rem;
    font-weight: 600;
    box-shadow: var(--shadow);
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
  }

  .msg {
    max-width: 70%;
    padding: 10px 14px;
    border-radius: var(--border-radius);
    margin: 6px 0;
    word-wrap: break-word;
    line-height: 1.4;
    position: relative;
    animation: fadeIn 0.2s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg.you {
    background: var(--you-msg-bg);
    color: var(--text-light);
    align-self: flex-end;
    margin-left: auto;
  }

  .msg.other {
    background: var(--other-msg-bg);
    color: var(--text-dark);
    align-self: flex-start;
    margin-right: auto;
  }

  .msg.system {
    background: #f8c291;
    color: #e58e26;
    align-self: center;
    font-style: italic;
    max-width: 90%;
  }

  #inputArea {
    display: flex;
    padding: 12px;
    background: var(--input-bg);
    border-top: 1px solid rgba(0,0,0,0.05);
  }

  #inputArea input[type="text"] {
    flex: 1;
    padding: 12px 16px;
    border-radius: 24px;
    border: 1px solid rgba(0,0,0,0.1);
    font-size: 14px;
    outline: none;
  }

  #inputArea input[type="text"]:focus {
    border-color: #a4b0be;
  }

  #inputArea button {
    margin-left: 12px;
    padding: 12px 24px;
    border-radius: 24px;
    border: none;
    background: var(--btn-success);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  #inputArea button:hover:not(:disabled) {
    background: #28c76f;
  }

  #groups {
    margin-top: 16px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .group-btn {
    background: var(--btn-primary);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
    flex: 1 1 45%;
    min-width: 100px;
    text-align: center;
  }

  .group-btn:hover {
    background: #2c39da;
    transform: translateY(-1px);
  }

  .group-btn.active {
    background: #ff6347;
    box-shadow: 0 0 0 2px white, 0 0 0 4px #ff6347;
  }

  #callArea {
    padding: 12px;
    background: var(--input-bg);
    display: flex;
    gap: 12px;
    align-items: center;
    border-top: 1px solid rgba(0,0,0,0.05);
  }

  #callBtn {
    background: var(--btn-success);
    color: white;
    padding: 10px 18px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  #callBtn:hover:not(:disabled) {
    background: #28c76f;
  }

  #hangupBtn {
    background: var(--btn-danger);
    color: white;
    padding: 10px 18px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  #hangupBtn:hover:not(:disabled) {
    background: #ff5252;
  }

  #localAudio, #remoteAudio {
    display: none;
  }

  #status {
    margin-top: 12px;
    font-size: 12px;
    color: #a4b0be;
    min-height: 18px;
  }

  .hidden {
    display: none !important;
  }

  /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
  @media (max-width: 768px) {
    #sidebar {
      width: 220px;
      font-size: 14px;
    }
  }

  @media (max-width: 480px) {
    body {
      flex-direction: column;
    }
    #sidebar {
      width: 100%;
      height: auto;
      max-height: 40vh;
    }
    #groups {
      justify-content: space-between;
    }
    .msg {
      max-width: 85%;
    }
  }
</style>
</head>
<body>

<div id="sidebar">
  <h3>–ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–π<br>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h3>
  <input id="usernameInput" placeholder="–í–∞—à–µ –∏–º—è" autocomplete="off" />
  <div id="groups"></div>
  <button id="connectBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  <div id="status"></div>
</div>

<div id="main">
  <div id="chatHeader">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</div>
  <div id="messages"></div>
  <div id="inputArea" class="hidden">
    <input id="messageInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500" />
    <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
  <div id="callArea" class="hidden">
    <button id="callBtn">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
    <button id="hangupBtn" disabled>‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    <audio id="localAudio" autoplay muted></audio>
    <audio id="remoteAudio" autoplay></audio>
  </div>
</div>

<script>
(() => {
  // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
  const DEFAULT_WS_URL = 'wss://kotochat-e22r.onrender.com';
  const GROUPS = ['–û–±—â–∏–π', '–†–∞–±–æ—Ç–∞', '–î—Ä—É–∑—å—è'];
  const STUN_SERVERS = [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' }
  ];

  // === –°–æ—Å—Ç–æ—è–Ω–∏–µ ===
  let ws = null;
  let username = '';
  let currentGroup = '';
  let connected = false;
  let localStream = null;
  let peerConnection = null;

  // === DOM —ç–ª–µ–º–µ–Ω—Ç—ã ===
  const usernameInput = document.getElementById('usernameInput');
  const connectBtn = document.getElementById('connectBtn');
  const statusEl = document.getElementById('status');
  const groupsDiv = document.getElementById('groups');
  const chatHeader = document.getElementById('chatHeader');
  const messagesDiv = document.getElementById('messages');
  const inputArea = document.getElementById('inputArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const callArea = document.getElementById('callArea');
  const callBtn = document.getElementById('callBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  const localAudio = document.getElementById('localAudio');
  const remoteAudio = document.getElementById('remoteAudio');

  // === –£—Ç–∏–ª–∏—Ç—ã ===
  const showStatus = (msg, isError = false) => {
    statusEl.textContent = msg;
    statusEl.style.color = isError ? '#ff6b6b' : '#a4b0be';
  };

  const addMessage = (usernameMsg, text, isYou = false, isSystem = false, time = Date.now()) => {
    const div = document.createElement('div');
    div.className = `msg ${isSystem ? 'system' : isYou ? 'you' : 'other'}`;
    const timeStr = new Date(time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    div.innerHTML = `<strong>${usernameMsg}</strong>: ${text} <small>(${timeStr})</small>`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  };

  // === –ì—Ä—É–ø–ø—ã ===
  const addGroupButtons = () => {
    groupsDiv.innerHTML = '';
    GROUPS.forEach(group => {
      const btn = document.createElement('button');
      btn.textContent = group;
      btn.className = 'group-btn';
      btn.dataset.group = group;
      btn.onclick = () => switchGroup(group);
      groupsDiv.appendChild(btn);
    });
  };

  const updateActiveGroupButton = () => {
    document.querySelectorAll('.group-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.group === currentGroup);
    });
  };

  const switchGroup = (group) => {
    if (!connected) return showStatus('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å', true);
    if (group === currentGroup) return;

    hangupCall(); // –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ –≥—Ä—É–ø–ø—ã

    currentGroup = group;
    chatHeader.textContent = `–ì—Ä—É–ø–ø–∞: ${group}`;
    messagesDiv.innerHTML = '';
    updateActiveGroupButton();
    ws.send(JSON.stringify({ type: 'join', username, group }));
    inputArea.classList.remove('hidden');
    callArea.classList.remove('hidden');
  };

  // === WebSocket ===
  const connect = () => {
    username = usernameInput.value.trim();
    if (!username) return showStatus('–í–≤–µ–¥–∏—Ç–µ –∏–º—è', true);

    if (ws) ws.close();

    ws = new WebSocket(DEFAULT_WS_URL);
    showStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');

    ws.onopen = () => {
      connected = true;
      showStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
      addGroupButtons();
      inputArea.classList.add('hidden');
      callArea.classList.add('hidden');
      currentGroup = '';
      messagesDiv.innerHTML = '';
      localStorage.setItem('messengerUsername', username);
    };

    ws.onerror = () => {
      showStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', true);
      connected = false;
    };

    ws.onclose = () => {
      connected = false;
      showStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
      inputArea.classList.add('hidden');
      callArea.classList.add('hidden');
      messagesDiv.innerHTML = '';
      currentGroup = '';
      hangupCall();
      updateActiveGroupButton();
    };

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        switch (data.type) {
          case 'history':
            messagesDiv.innerHTML = '';
            (data.messages || []).forEach(msg => {
              addMessage(msg.username, msg.text, msg.username === username, false, msg.timestamp);
            });
            break;
          case 'message':
            addMessage(data.username, data.text, data.username === username, false, data.timestamp);
            if (data.username !== username && Notification.permission === 'granted') {
              new Notification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ ${currentGroup}`, {
                body: `${data.username}: ${data.text}`,
                icon: 'https://cdn-icons-png.flaticon.com/512/2526/2526410.png'
              });
            }
            break;
          case 'notification':
            addMessage('–°–∏—Å—Ç–µ–º–∞', data.text, false, true);
            break;
          case 'signal':
            handleSignal(data);
            break;
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
      }
    };
  };

  // === –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ===
  const sendMessage = () => {
    const text = messageInput.value.trim();
    if (!text || !currentGroup) return;
    ws.send(JSON.stringify({ type: 'message', text, group: currentGroup }));
    messageInput.value = '';
    messageInput.focus();
  };

  // === WebRTC ===
  const createPeerConnection = (target) => {
    if (peerConnection) peerConnection.close();
    peerConnection = new RTCPeerConnection({ iceServers: STUN_SERVERS });

    peerConnection.onicecandidate = (event) => {
      if (event.candidate) {
        ws.send(JSON.stringify({ type: 'signal', to: target, signalData: { candidate: event.candidate } }));
      }
    };

    peerConnection.ontrack = (event) => {
      remoteAudio.srcObject = event.streams[0];
      remoteAudio.style.display = 'block';
    };

    peerConnection.onconnectionstatechange = () => {
      if (['disconnected', 'failed', 'closed'].includes(peerConnection.connectionState)) {
        hangupCall();
      }
    };

    return peerConnection;
  };

  const startCall = async () => {
    if (!currentGroup) return showStatus('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É', true);
    if (peerConnection) return;

    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localAudio.srcObject = localStream;
      localAudio.style.display = 'block';

      createPeerConnection(currentGroup);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      ws.send(JSON.stringify({ type: 'signal', to: currentGroup, signalData: { sdp: peerConnection.localDescription } }));

      callBtn.disabled = true;
      hangupBtn.disabled = false;
      showStatus('üìû –ó–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω...');

    } catch (err) {
      showStatus(err.name === 'NotAllowedError' 
        ? '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É' 
        : `–û—à–∏–±–∫–∞ –∑–≤–æ–Ω–∫–∞: ${err.message}`, true);
      hangupCall();
    }
  };

  const handleSignal = async (data) => {
    try {
      if (!peerConnection) {
        createPeerConnection(data.from);
        peerConnection.ontrack = (event) => {
          remoteAudio.srcObject = event.streams[0];
          remoteAudio.style.display = 'block';
        };
      }

      if (data.signalData.sdp) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.signalData.sdp));
        if (data.signalData.sdp.type === 'offer') {
          if (!localStream) {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            localAudio.srcObject = localStream;
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
          }
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: 'signal', to: data.from, signalData: { sdp: peerConnection.localDescription } }));
          callBtn.disabled = true;
          hangupBtn.disabled = false;
          showStatus('üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫');
        }
      } else if (data.signalData.candidate) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.signalData.candidate));
      }
    } catch (err) {
      console.error('WebRTC –æ—à–∏–±–∫–∞:', err);
      showStatus(`WebRTC: ${err.message}`, true);
      hangupCall();
    }
  };

  const hangupCall = () => {
    if (peerConnection) {
      peerConnection.close();
      peerConnection = null;
    }
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    localAudio.style.display = 'none';
    remoteAudio.style.display = 'none';
    callBtn.disabled = false;
    hangupBtn.disabled = true;
  };

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  (() => {
    const saved = localStorage.getItem('messengerUsername');
    if (saved) usernameInput.value = saved;

    connectBtn.onclick = connect;
    sendBtn.onclick = sendMessage;
    messageInput.onkeyup = (e) => { if (e.key === 'Enter' && !e.shiftKey) sendMessage(); };
    callBtn.onclick = startCall;
    hangupBtn.onclick = hangupCall;

    if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
      Notification.requestPermission();
    }
  })();
})();
</script>

</body>
</html>
