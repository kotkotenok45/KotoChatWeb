<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ö–æ—Ç–æ—á–∞—Ç ‚Äî –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏</title>
<style>
  :root {
    --sidebar-bg: #2f3542;
    --main-bg: #f1f2f6;
    --header-bg: #57606f;
    --input-bg: #dfe4ea;
    --you-msg-bg: #70a1ff;
    --other-msg-bg: #dfe4ea;
    --btn-primary: #3742fa;
    --btn-success: #2ed573;
    --btn-danger: #ff6b6b;
    --text-light: white;
    --text-dark: #2f3542;
    --border-radius: 15px;
    --shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    display: flex;
    height: 100vh;
    overflow: hidden;
    background: #ecf0f1;
  }

  #loginScreen {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    padding: 20px;
    text-align: center;
  }

  #loginScreen h1 {
    font-size: 2.4rem;
    margin-bottom: 10px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  #loginScreen p {
    margin-bottom: 30px;
    font-size: 1.1rem;
    max-width: 500px;
  }

  #usernameInput {
    padding: 14px 20px;
    font-size: 1.1rem;
    border: none;
    border-radius: 30px;
    width: 300px;
    max-width: 90%;
    outline: none;
    margin-bottom: 20px;
    text-align: center;
  }

  #connectBtn {
    background: white;
    color: #2575fc;
    border: none;
    border-radius: 30px;
    padding: 14px 40px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  #connectBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
  }

  #sidebar {
    width: 260px;
    background: var(--sidebar-bg);
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    padding: 16px;
    box-shadow: var(--shadow);
    overflow-y: auto;
  }

  #sidebar h3 {
    margin: 0 0 16px;
    font-size: 1.3rem;
    text-align: center;
  }

  #accountInfo {
    background: rgba(255,255,255,0.1);
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 16px;
    text-align: center;
  }

  #accountName {
    font-weight: bold;
    font-size: 1.1rem;
  }

  #accountStatus {
    font-size: 0.85rem;
    opacity: 0.8;
  }

  #logoutBtn {
    background: #ff6b6b;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px;
    margin-top: 8px;
    font-size: 0.9rem;
    cursor: pointer;
  }

  #groups {
    margin-top: 16px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .group-btn {
    background: var(--btn-primary);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 13px;
    flex: 1 1 45%;
    min-width: 100px;
    text-align: center;
  }

  .group-btn:hover { background: #2c39da; }
  .group-btn.active { background: #ff9f43; }

  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--main-bg);
  }

  #chatHeader {
    background: var(--header-bg);
    color: var(--text-light);
    padding: 12px 16px;
    font-weight: 600;
    box-shadow: var(--shadow);
    display: flex;
    justify-content: space-between;
  }

  #onlineCount {
    font-size: 0.9rem;
    opacity: 0.8;
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
  }

  .msg {
    max-width: 70%;
    padding: 10px 14px;
    border-radius: var(--border-radius);
    margin: 6px 0;
    word-wrap: break-word;
    line-height: 1.4;
    animation: fadeIn 0.2s;
  }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  .msg.you { background: var(--you-msg-bg); color: white; align-self: flex-end; margin-left: auto; }
  .msg.other { background: var(--other-msg-bg); color: var(--text-dark); align-self: flex-start; margin-right: auto; }
  .msg.system { background: #f8c291; color: #e58e26; align-self: center; font-style: italic; max-width: 90%; }

  #inputArea, #callArea {
    display: none;
    padding: 12px;
    background: var(--input-bg);
    gap: 12px;
    align-items: center;
    border-top: 1px solid rgba(0,0,0,0.05);
  }

  #inputArea input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 24px;
    border: 1px solid rgba(0,0,0,0.1);
    outline: none;
  }

  #inputArea button, #callArea button {
    padding: 10px 18px;
    border: none;
    border-radius: 20px;
    color: white;
    font-weight: 600;
    cursor: pointer;
  }

  #inputArea button { background: var(--btn-success); }
  #callBtn { background: var(--btn-success); }
  #hangupBtn { background: var(--btn-danger); }

  .hidden { display: none !important; }

  @media (max-width: 768px) {
    #sidebar { width: 220px; }
    #accountInfo { font-size: 0.9rem; }
  }

  @media (max-width: 480px) {
    body { flex-direction: column; }
    #sidebar { width: 100%; max-height: 40vh; }
  }
</style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
<div id="loginScreen">
  <h1>üêà –ö–æ—Ç–æ—á–∞—Ç</h1>
  <p>–ó–∞–π–¥–∏—Ç–µ –ø–æ–¥ —Å–≤–æ–∏–º –∏–º–µ–Ω–µ–º ‚Äî –æ–Ω–æ –±—É–¥–µ—Ç –≤–∞—à–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º</p>
  <input id="usernameInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞ –∏–ª–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü–∞)" maxlength="20" autocomplete="off" />
  <button id="connectBtn">–í–æ–π—Ç–∏ –≤ —á–∞—Ç</button>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—Å–∫—Ä—ã—Ç –¥–æ –≤—Ö–æ–¥–∞) -->
<div id="app" class="hidden">
  <div id="sidebar">
    <h3>–ö–æ—Ç–æ—á–∞—Ç</h3>
    <div id="accountInfo">
      <div id="accountName">‚Äî</div>
      <div id="accountStatus">–æ—Ñ—Ñ–ª–∞–π–Ω</div>
      <button id="logoutBtn">–í—ã–π—Ç–∏</button>
    </div>
    <div id="groups"></div>
  </div>

  <div id="main">
    <div id="chatHeader">
      <span id="groupName">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</span>
      <span id="onlineCount">‚Äî</span>
    </div>
    <div id="messages"></div>
    <div id="inputArea">
      <input id="messageInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500" />
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <div id="callArea">
      <button id="callBtn">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
      <button id="hangupBtn" disabled>‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      <audio id="localAudio" autoplay muted></audio>
      <audio id="remoteAudio" autoplay></audio>
    </div>
  </div>
</div>

<script>
(() => {
  // === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ===
  const WS_URL = 'wss://kotochat-e22r.onrender.com';
  const GROUPS = ['–û–±—â–∏–π', '–†–∞–±–æ—Ç–∞', '–î—Ä—É–∑—å—è'];
  
  // === –°–æ—Å—Ç–æ—è–Ω–∏–µ ===
  let ws = null;
  let accountId = null;
  let username = '';
  let currentGroup = '';
  let connected = false;
  let localStream = null;
  let peerConnection = null;

  // === DOM ===
  const loginScreen = document.getElementById('loginScreen');
  const app = document.getElementById('app');
  const usernameInput = document.getElementById('usernameInput');
  const connectBtn = document.getElementById('connectBtn');
  const accountNameEl = document.getElementById('accountName');
  const accountStatusEl = document.getElementById('accountStatus');
  const logoutBtn = document.getElementById('logoutBtn');
  const groupsDiv = document.getElementById('groups');
  const groupNameEl = document.getElementById('groupName');
  const onlineCountEl = document.getElementById('onlineCount');
  const messagesDiv = document.getElementById('messages');
  const inputArea = document.getElementById('inputArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const callArea = document.getElementById('callArea');
  const callBtn = document.getElementById('callBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  const localAudio = document.getElementById('localAudio');
  const remoteAudio = document.getElementById('remoteAudio');

  // === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
  const addMessage = (usernameMsg, text, isYou = false, isSystem = false, time = Date.now()) => {
    const div = document.createElement('div');
    div.className = `msg ${isSystem ? 'system' : isYou ? 'you' : 'other'}`;
    const timeStr = new Date(time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    div.innerHTML = `<strong>${usernameMsg}</strong>: ${text} <small>(${timeStr})</small>`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  };

  const updateOnlineCount = (count) => {
    onlineCountEl.textContent = `üë• ${count} –æ–Ω–ª–∞–π–Ω`;
  };

  const setAccountStatus = (online = false) => {
    accountStatusEl.textContent = online ? '‚úÖ –æ–Ω–ª–∞–π–Ω' : '‚≠ï –æ—Ñ—Ñ–ª–∞–π–Ω';
    accountStatusEl.style.color = online ? '#2ed573' : '#ff6b6b';
  };

  // === –†–∞–±–æ—Ç–∞ —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º ===
  const loadAccount = () => {
    const saved = localStorage.getItem('kotochat_account');
    if (saved) {
      try {
        const acc = JSON.parse(saved);
        usernameInput.value = acc.username;
        return acc;
      } catch (e) {
        localStorage.removeItem('kotochat_account');
      }
    }
    return null;
  };

  const saveAccount = (username, id) => {
    localStorage.setItem('kotochat_account', JSON.stringify({ username, id, timestamp: Date.now() }));
  };

  const clearAccount = () => {
    localStorage.removeItem('kotochat_account');
    accountId = null;
    username = '';
  };

  // === –ì—Ä—É–ø–ø—ã ===
  const addGroupButtons = () => {
    groupsDiv.innerHTML = '';
    GROUPS.forEach(group => {
      const btn = document.createElement('button');
      btn.textContent = group;
      btn.className = 'group-btn';
      btn.onclick = () => switchGroup(group);
      groupsDiv.appendChild(btn);
    });
  };

  const updateActiveGroup = () => {
    document.querySelectorAll('.group-btn').forEach(btn => {
      btn.classList.toggle('active', btn.textContent === currentGroup);
    });
  };

  const switchGroup = (group) => {
    if (!connected) return;
    if (group === currentGroup) return;

    // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫ –ø—Ä–∏ —Å–º–µ–Ω–µ –≥—Ä—É–ø–ø—ã
    hangupCall();

    currentGroup = group;
    groupNameEl.textContent = `–ì—Ä—É–ø–ø–∞: ${group}`;
    messagesDiv.innerHTML = '';
    updateActiveGroup();
    
    ws.send(JSON.stringify({ type: 'join', username, accountId, group }));
    inputArea.style.display = 'flex';
    callArea.style.display = 'flex';
  };

  // === WebSocket ===
  const connect = () => {
    const name = usernameInput.value.trim();
    if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');

    if (ws) ws.close();

    ws = new WebSocket(WS_URL);
    loginScreen.classList.add('hidden');

    ws.onopen = () => {
      console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∞–∫–∫–∞—É–Ω—Ç–∞ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ UUID –≤ –±—É–¥—É—â–µ–º)
      accountId = 'u_' + Math.random().toString(36).substr(2, 9);
      username = name;
      
      saveAccount(username, accountId);
      accountNameEl.textContent = username;
      setAccountStatus(true);
      accountStatusEl.style.display = 'block';
      
      ws.send(JSON.stringify({ type: 'login', username, accountId }));
      addGroupButtons();
    };

    ws.onerror = (e) => {
      console.error('‚ùå WebSocket error:', e);
      alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
      logout();
    };

    ws.onclose = () => {
      console.log('üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
      connected = false;
      setAccountStatus(false);
      if (loginScreen.classList.contains('hidden')) {
        alert('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤—Ö–æ–¥.');
        logout();
      }
    };

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        switch (data.type) {
          case 'login_success':
            connected = true;
            addMessage('–°–∏—Å—Ç–µ–º–∞', `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}!`, false, true);
            break;
          
          case 'login_failure':
            alert(`–ò–º—è "${data.username}" —É–∂–µ –∑–∞–Ω—è—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ.`);
            logout();
            break;

          case 'join_ack':
            updateOnlineCount(data.onlineCount || 0);
            addMessage('–°–∏—Å—Ç–µ–º–∞', `–í—ã –≤–æ—à–ª–∏ –≤ –≥—Ä—É–ø–ø—É "${data.group}"`, false, true);
            break;

          case 'notification':
            addMessage('–°–∏—Å—Ç–µ–º–∞', data.text, false, true);
            break;

          case 'message':
            addMessage(data.username, data.text, data.accountId === accountId, false, data.timestamp);
            break;

          case 'online_update':
            updateOnlineCount(data.count);
            break;

          case 'signal':
            handleSignal(data);
            break;
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
      }
    };
  };

  // === –í—ã—Ö–æ–¥ ===
  const logout = () => {
    if (ws) {
      ws.close();
      ws = null;
    }
    hangupCall();
    clearAccount();
    loginScreen.classList.remove('hidden');
    app.classList.add('hidden');
    messagesDiv.innerHTML = '';
    currentGroup = '';
  };

  // === –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ===
  const sendMessage = () => {
    const text = messageInput.value.trim();
    if (!text || !currentGroup) return;
    ws.send(JSON.stringify({ 
      type: 'message', 
      text, 
      username, 
      accountId,
      group: currentGroup 
    }));
    messageInput.value = '';
  };

  // === WebRTC (—É–ø—Ä–æ—â—ë–Ω–Ω–æ) ===
  const STUN_SERVERS = [{ urls: 'stun:stun.l.google.com:19302' }];

  const createPeerConnection = (target) => {
    if (peerConnection) peerConnection.close();
    peerConnection = new RTCPeerConnection({ iceServers: STUN_SERVERS });

    peerConnection.onicecandidate = (event) => {
      if (event.candidate) {
        ws.send(JSON.stringify({ 
          type: 'signal', 
          to: target, 
          from: accountId,
          signalData: { candidate: event.candidate } 
        }));
      }
    };

    peerConnection.ontrack = (event) => {
      remoteAudio.srcObject = event.streams[0];
    };

    peerConnection.onconnectionstatechange = () => {
      if (['disconnected', 'failed', 'closed'].includes(peerConnection.connectionState)) {
        hangupCall();
      }
    };

    return peerConnection;
  };

  const startCall = async () => {
    if (!currentGroup) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É');
    if (peerConnection) return;

    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      localAudio.srcObject = localStream;

      createPeerConnection(currentGroup);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      ws.send(JSON.stringify({ 
        type: 'signal', 
        to: currentGroup, 
        from: accountId,
        signalData: { sdp: peerConnection.localDescription } 
      }));

      callBtn.disabled = true;
      hangupBtn.disabled = false;
      addMessage('–°–∏—Å—Ç–µ–º–∞', 'üìû –ó–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω...', false, true);

    } catch (err) {
      alert(err.name === 'NotAllowedError' ? '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É' : `–û—à–∏–±–∫–∞: ${err.message}`);
      hangupCall();
    }
  };

  const handleSignal = async (data) => {
    try {
      if (!peerConnection) {
        createPeerConnection(data.from);
        peerConnection.ontrack = (event) => {
          remoteAudio.srcObject = event.streams[0];
        };
      }

      if (data.signalData.sdp) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.signalData.sdp));
        if (data.signalData.sdp.type === 'offer') {
          if (!localStream) {
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            localAudio.srcObject = localStream;
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
          }
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          ws.send(JSON.stringify({ 
            type: 'signal', 
            to: data.from, 
            from: accountId,
            signalData: { sdp: peerConnection.localDescription } 
          }));
          callBtn.disabled = true;
          hangupBtn.disabled = false;
          addMessage('–°–∏—Å—Ç–µ–º–∞', 'üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫', false, true);
        }
      } else if (data.signalData.candidate) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.signalData.candidate));
      }
    } catch (err) {
      console.error('WebRTC error:', err);
      hangupCall();
    }
  };

  const hangupCall = () => {
    if (peerConnection) {
      peerConnection.close();
      peerConnection = null;
    }
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    callBtn.disabled = false;
    hangupBtn.disabled = true;
  };

  // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
  (() => {
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
    const saved = loadAccount();
    if (saved && saved.username) {
      usernameInput.value = saved.username;
      // –ú–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–π—Ç–∏ ‚Äî –Ω–æ –ª—É—á—à–µ –¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
    }

    // –°–æ–±—ã—Ç–∏—è
    connectBtn.onclick = connect;
    logoutBtn.onclick = logout;
    sendBtn.onclick = sendMessage;
    messageInput.onkeyup = (e) => { if (e.key === 'Enter') sendMessage(); };
    callBtn.onclick = startCall;
    hangupBtn.onclick = hangupCall;

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    if (Notification.permission === 'default') {
      Notification.requestPermission();
    }
  })();
})();
</script>

</body>
</html>
